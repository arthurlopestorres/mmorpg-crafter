//! INICIO CORE.JS
const isLocal = "localhost" === window.location.hostname || "127.0.0.1" === window.location.hostname, API = isLocal ? "http://localhost:10000" : "https://mmorpg-crafter.onrender.com", RECAPTCHA_SITE_KEY = "6LeLG-krAAAAAFhUEHtBb3UOQefm93Oz8k5DTpx_"; let processedFotoBlob = null; const socket = io.connect(isLocal ? "http://localhost:10000" : "https://mmorpg-crafter.onrender.com"); function showLoading() { const e = document.getElementById("loadingOverlay"); e && e.remove(); const t = document.createElement("div"); t.id = "loadingOverlay", t.style.position = "fixed", t.style.top = "0", t.style.left = "0", t.style.width = "100%", t.style.height = "100%", t.style.backgroundColor = "rgba(0, 0, 0, 0.5)", t.style.zIndex = "10000", t.style.display = "flex", t.style.alignItems = "center", t.style.justifyContent = "center"; const o = document.createElement("div"); o.className = "spinner", o.style.border = "8px solid #f3f3f3", o.style.borderTop = "8px solid #3498db", o.style.borderRadius = "50%", o.style.width = "60px", o.style.height = "60px", o.style.animation = "spin 1s linear infinite", t.appendChild(o), document.body.appendChild(t) } function hideLoading() { const e = document.getElementById("loadingOverlay"); e && e.remove() } async function safeApi(e, t = {}) { sessionStorage.getItem("loggedIn") || showLoading(); try { t.credentials || (t.credentials = "include"); const o = `${API}${e}`, a = await fetch(o, t); if (403 === a.status) throw mostrarPopupAcessoNegado(), new Error("Acesso negado"); let n; try { n = await a.json() } catch (e) { throw new Error("Resposta inválida do servidor") } if (!a.ok) throw new Error(n.erro || `HTTP error! status: ${a.status}`); return n } finally { sessionStorage.getItem("loggedIn") || hideLoading() } } function mostrarPopupAcessoNegado() { const e = document.getElementById("overlayAcessoNegado"); e && e.remove(); const t = document.getElementById("modalAcessoNegado"); t && t.remove(); const o = document.createElement("div"); o.id = "overlayAcessoNegado", o.style.position = "fixed", o.style.top = "0", o.style.left = "0", o.style.width = "100%", o.style.height = "100%", o.style.backgroundColor = "rgba(0, 0, 0, 0.5)", o.style.zIndex = "999", document.body.appendChild(o); const a = document.createElement("div"); a.id = "modalAcessoNegado", a.style.position = "fixed", a.style.top = "50%", a.style.left = "50%", a.style.transform = "translate(-50%, -50%)", a.style.backgroundColor = "white", a.style.padding = "20px", a.style.zIndex = "1001", a.style.borderRadius = "5px", a.style.boxShadow = "0 2px 10px rgba(0,0,0,0.1)", a.innerHTML = '\n    <div id="popupDeErro403" style="display: flex; justify-content: space-between; align-items: center;">\n      <h3>Acesso Negado</h3>\n      <button id="fecharAcessoNegado" style="background: none; border: none; font-size: 16px; cursor: pointer;">❌</button>\n    </div>\n    <p>Você não tem permissão para esta ação.</p>\n    <p>A página será recarregada em 3 segundos...</p>\n    <button onclick="window.location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Recarregar agora</button>\n  ', document.body.appendChild(a); const n = document.getElementById("fecharAcessoNegado"); n && n.addEventListener("click", (() => { a.remove(), o.remove() })), o.addEventListener("click", (() => { a.remove(), o.remove() })), setTimeout((() => { window.location.reload() }), 3e3) } const conteudo = document.getElementById("conteudo"); function debounce(e, t) { let o; return (...a) => { clearTimeout(o), o = setTimeout((() => e(...a)), t) } } function mostrarPopupPendencias(e) { const t = criarOverlay(), o = document.createElement("div"); o.id = "popupPendencias", o.style.position = "fixed", o.style.top = "50%", o.style.left = "50%", o.style.transform = "translate(-50%, -50%)", o.style.backgroundColor = "white", o.style.padding = "20px", o.style.zIndex = "1000", o.style.maxHeight = "80vh", o.style.overflowY = "auto", o.innerHTML = `\n        <h2>Convites Pendentes</h2>\n        <p>Você tem convites para times. Aceite um para acessar os jogos compartilhados.</p>\n        <ul id="listaPendenciasPopup">\n            ${e.map((e => `\n                <li style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">\n                    Convite de <strong>${e.from}</strong>\n                    <div style="margin-top: 8px;">\n                        <button onclick="aceitarConvidar('${e.from}'); document.getElementById('popupPendencias').remove(); document.getElementById('overlay').remove();" style="margin-right: 8px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Aceitar</button>\n                        <button onclick="recusarConvidar('${e.from}'); refreshPendenciasPopup();" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Recusar</button>\n                    </div>\n                </li>\n            `)).join("")}\n        </ul>\n        <button onclick="mostrarPopupNovoJogo(); document.getElementById('popupPendencias').remove(); document.getElementById('overlay').remove();" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Criar Meu Próprio Jogo</button>\n        <button id="btnFecharPendencias" style="margin-top: 10px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Fechar</button>\n    `, document.body.appendChild(o), document.getElementById("btnFecharPendencias").addEventListener("click", (() => { o.remove(), t.remove(), mostrarPopupNovoJogo() })), window.refreshPendenciasPopup = async () => { try { const e = await safeApi("/pendencias"), a = document.getElementById("listaPendenciasPopup"); 0 === e.length ? (a.innerHTML = "<li>Nenhum convite pendente restante.</li>", document.querySelector('button[onclick*="mostrarPopupNovoJogo"]').style.display = "none", document.getElementById("btnFecharPendencias").textContent = "Criar Novo Jogo", document.getElementById("btnFecharPendencias").onclick = () => { o.remove(), t.remove(), mostrarPopupNovoJogo() }) : a.innerHTML = e.map((e => `\n                    <li style="margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">\n                        Convite de <strong>${e.from}</strong>\n                        <div style="margin-top: 8px;">\n                            <button onclick="aceitarConvidar('${e.from}'); document.getElementById('popupPendencias').remove(); document.getElementById('overlay').remove();" style="margin-right: 8px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Aceitar</button>\n                            <button onclick="recusarConvidar('${e.from}'); refreshPendenciasPopup();" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Recusar</button>\n                        </div>\n                    </li>\n                `)).join("") } catch (e) { console.error("Erro ao recarregar pendências:", e) } } } async function carregarUserStatus() { const e = localStorage.getItem("currentGame") || "Pax Dei"; try { const t = await safeApi(`/user-status?game=${encodeURIComponent(e)}`); sessionStorage.setItem("isFounder", t.isFounder.toString()), sessionStorage.setItem("isAdmin", t.isAdmin.toString()), sessionStorage.setItem("effectiveUser", t.effectiveUser), sessionStorage.setItem("permissao", JSON.stringify(t.permissao || {})) } catch (e) { console.error("[USER STATUS] Erro ao carregar status:", e), sessionStorage.setItem("isFounder", "false"), sessionStorage.setItem("isAdmin", "false"), sessionStorage.setItem("permissao", JSON.stringify({})) } } function isUserAdmin() { return "true" === sessionStorage.getItem("isAdmin") } function isUserFounder() { return "true" === sessionStorage.getItem("isFounder") } function hasPermission(e) { const t = JSON.parse(sessionStorage.getItem("permissao") || "{}"); return isUserAdmin() || !0 === t[e] } async function initGames() { let e = localStorage.getItem("currentGame") || "Pax Dei"; e || (e = "Pax Dei", localStorage.setItem("currentGame", e)); try { const t = await safeApi("/games"); t.includes(e) || (e = t.length > 0 ? t[0] : "Pax Dei", localStorage.setItem("currentGame", e)) } catch (t) { console.error("[INIT GAMES] Erro ao validar jogos acessíveis:", t), e = "Pax Dei", localStorage.setItem("currentGame", e) } socket.emit("joinGame", e) } function mostrarPopupNovoJogo() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupNovoJogo", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Novo Jogo</h2>\n        <form id="formNovoJogo">\n            <input type="text" id="nomeJogo" placeholder="Nome do Jogo" required pattern="[a-zA-Z0-9 ]+">\n            <button type="submit">Criar</button>\n            <button type="button" id="btnCancelarNovoJogo">Cancelar</button>\n            <p id="erroNovoJogo" style="color: red; display: none;"></p>\n        </form>\n    ', document.body.appendChild(t), document.getElementById("formNovoJogo").addEventListener("submit", (async o => { o.preventDefault(); const a = document.getElementById("nomeJogo").value.trim(); if (!a) return document.getElementById("erroNovoJogo").textContent = "Nome do jogo é obrigatório", void (document.getElementById("erroNovoJogo").style.display = "block"); try { const o = await safeApi("/games", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: a }) }); o.sucesso ? (localStorage.setItem("currentGame", a), t.remove(), e.remove(), window.location.reload()) : (document.getElementById("erroNovoJogo").textContent = o.erro || "Erro ao criar jogo", document.getElementById("erroNovoJogo").style.display = "block") } catch (e) { document.getElementById("erroNovoJogo").textContent = "Erro ao criar jogo", document.getElementById("erroNovoJogo").style.display = "block" } })), document.getElementById("btnCancelarNovoJogo").addEventListener("click", (() => { t.remove(), e.remove() })) }
//! FIM CORE.JS
//! INICIO UTILS.JS
function formatQuantity(e) { return null == e ? "0" : (e = Number(e), isNaN(e) ? "0" : Number.isInteger(e) ? e : e.toFixed(3).replace(/\.?0+$/, "")) } function mostrarErro(e) { const t = document.getElementById("overlay"); t && t.remove(); const o = document.getElementById("modalErro"); o && o.remove(); const a = criarOverlay(), n = document.createElement("div"); n.id = "modalErro", n.style.position = "fixed", n.style.top = "50%", n.style.left = "50%", n.style.transform = "translate(-50%, -50%)", n.style.backgroundColor = "white", n.style.padding = "20px", n.style.zIndex = "1000", n.style.borderRadius = "5px", n.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)"; const r = document.createElement("button"); r.id = "fecharModal", r.style.background = "none", r.style.border = "none", r.style.fontSize = "16px", r.style.cursor = "pointer", r.innerHTML = "❌", n.innerHTML = `\n        <div style="display: flex; justify-content: space-between; align-items: center;">\n            <h3>Erro</h3>\n            ${r.outerHTML}\n        </div>\n        <p id="mensagemErro">${e}</p>\n    `, r.addEventListener("click", (() => { n.remove(); const e = document.getElementById("overlay"); e && e.remove() })), document.body.appendChild(n); const i = document.getElementById("fecharModal"); i && i.addEventListener("click", (() => { n.remove(); const e = document.getElementById("overlay"); e && e.remove() })), a.addEventListener("click", (() => { n.remove(), a.remove() })) } function mostrarSucesso(e) { const t = document.getElementById("overlaySucesso"); t && t.remove(); const o = document.getElementById("modalSucesso"); o && o.remove(); const a = criarOverlay(); a.id = "overlaySucesso"; const n = document.createElement("div"); n.id = "modalSucesso", n.style.position = "fixed", n.style.top = "50%", n.style.left = "50%", n.style.transform = "translate(-50%, -50%)", n.style.backgroundColor = "white", n.style.padding = "20px", n.style.zIndex = "1000", n.style.borderRadius = "5px", n.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)"; const r = document.createElement("button"); r.id = "fecharModalSucesso", r.style.background = "none", r.style.border = "none", r.style.fontSize = "16px", r.style.cursor = "pointer", r.innerHTML = "❌", n.innerHTML = `\n        <div style="display: flex; justify-content: space-between; align-items: center;">\n            <h3>Sucesso</h3>\n            ${r.outerHTML}\n        </div>\n        <p id="mensagemSucesso" style="color: green;">${e}</p>\n    `, r.addEventListener("click", (() => { n.remove(); const e = document.getElementById("overlaySucesso"); e && e.remove() })), document.body.appendChild(n); const i = document.getElementById("fecharModalSucesso"); i && i.addEventListener("click", (() => { n.remove(); const e = document.getElementById("overlaySucesso"); e && e.remove() })), a.addEventListener("click", (() => { n.remove(), a.remove() })) } function ordenarItens(e, t, o) { return [...e].sort(((e, a) => { const n = (e[o] || "").toLowerCase(), r = (a[o] || "").toLowerCase(); return "az" === t ? n.localeCompare(r) : "za" === t ? r.localeCompare(n) : 0 })) } function filtrarItens(e, t, o) { return t ? e.filter((e => (e[o] || "").toLowerCase().includes(t.toLowerCase()))) : e } function escapeHtml(e) { return e.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;") }
//! FIM UTILS.JS
//! INICIO auth.js
async function previewFotoPerfil(e) { const t = e.target.files[0]; if (!t) return; const o = new FileReader; o.onload = e => { const t = document.getElementById("previewFotoPerfil"); t && (t.src = e.target.result); const o = new Image; o.src = e.target.result, o.onload = () => { const e = document.createElement("canvas"), t = e.getContext("2d"); e.width = 100, e.height = 100, t.drawImage(o, 0, 0, 100, 100), e.toBlob((e => { processedFotoBlob = e }), "image/jpeg", .8) } }, o.readAsDataURL(t) } async function uploadFotoPerfil() { if (!processedFotoBlob && !document.getElementById("inputFotoPerfil").files[0]) return void mostrarErro("Selecione uma imagem primeiro"); const e = new FormData, t = processedFotoBlob || document.getElementById("inputFotoPerfil").files[0]; e.append("foto", t); try { const t = await safeApi("/upload-foto", { method: "POST", body: e }); if (t.sucesso) { const e = document.getElementById("previewFotoPerfil"); if (e) { const t = (new Date).getTime(); e.src = `/data/${encodeURIComponent(sessionStorage.getItem("userEmail") || "default")}/profile.jpg?${t}` } processedFotoBlob = null, mostrarSucesso("Foto atualizada com sucesso!") } else mostrarErro(t.erro || "Erro ao fazer upload") } catch (e) { if (console.error("Erro no upload:", e), mostrarErro("Erro ao fazer upload: " + e.message), e.message.includes("404")) { const e = document.getElementById("previewFotoPerfil"); e && (e.src = "/imagens/default-profile.jpg") } } } async function mostrarPopupMinhaConta() { const e = document.getElementById("popupMinhaConta"); e && e.remove(); const t = document.getElementById("menu-minha-conta").getBoundingClientRect(), o = document.createElement("div"); o.id = "popupMinhaConta", o.style.position = "fixed", o.style.top = "auto", o.style.bottom = "24px", o.style.left = `${t.right + 8}px`, o.style.right = "auto", o.style.transform = "none", o.style.backgroundColor = "white", o.style.padding = "0", o.style.zIndex = "1001", o.style.borderRadius = "var(--border-radius-xl)", o.style.boxShadow = "var(--shadow-xl)", o.style.minWidth = "300px", o.style.maxWidth = "400px", o.style.overflow = "hidden"; try { const e = await safeApi("/me"); sessionStorage.setItem("userEmail", e.email); const t = await safeApi("/games"), a = document.body.classList.contains("dark-mode"), n = e.fotoPath ? `${API}${e.fotoPath}?${Date.now()}` : null, r = !!n; o.innerHTML = `\n            <div class="minhaContaResumo"style="padding: 20px; border-bottom: 1px solid #e2e8f0;">\n                <div class="minhaContaResumo-tituloEimg">\n                    <h3 style="margin: 0 0 12px 0; font-size: 1.1rem;">Minha Conta</h3>\n                    <div style="width: 50px; display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; position: relative;">\n                        <div id="fotoPerfilContainer" style="position: relative; width: 150px; height: 150px; border-radius: 50%; overflow: hidden; border: 2px solid #e2e8f0; margin-bottom: 12px;">\n                            <img id="fotoPerfilImg" src="${n || ""}" alt="Foto de Perfil" style="width: 100%; height: 100%; object-fit: cover; display: ${r ? "block" : "none"};">\n                            <div id="editPencilOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; cursor: pointer; border-radius: 50%;">\n                                <span style="color: white; font-size: 10px;">Edit</span>\n                            </div>\n                        </div>\n                        <div id="uploadFotoContainer" style="width: 100%; text-align: center; display: ${r ? "none" : "block"};">\n                            <input type="file" id="inputFotoPerfil" accept="image/*" style="margin-bottom: 8px;">\n                            <img id="previewFotoPerfil" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: none; margin: 8px 0;">\n                            <button id="btnUploadFoto" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar Foto</button>\n                            <p style="display: none; font-size: 0.8rem; color: #666; margin-top: 4px;">Máx 150x150px, 50KB</p>\n                        </div>\n                    </div>\n                </div>\n                <div class="minhaConta-nomeWrapper" style="margin: 0 0 8px 0; font-size: 0.9rem;">\n                    <strong>Nome:</strong>\n                    <input type="text" id="editNome" value="#${e.id}${e.nome}">\n                    <span class="lapisEditarNome"></span>\n                    <button id="btnSalvarNome" style="margin-left: 8px; padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar</button>\n                </div>\n                <p style="margin: 0 0 16px 0; font-size: 0.9rem;"><strong>Email:</strong> ${e.email}</p>\n            </div>\n            <div style="padding: 16px 20px;">\n                <div style="margin-bottom: 16px;">\n                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;">Jogo Atual</label>\n                    <select id="gameSelectorDropdown">\n                        ${t.map((e => `<option value="${e}" ${e === localStorage.getItem("currentGame") ? "selected" : ""}>${e}</option>`)).join("")}\n                    </select>\n                </div>\n                <button id="btnNovoJogoDropdown" style="width: 100%; margin-bottom: 12px; padding: 10px; background: var(--primary-gradient); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 500;">Novo Jogo</button>\n                <button id="btnMudarSenha" style="width: 100%; margin-bottom: 12px; padding: 10px; background: #e2e8f0; color: #2d3748; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 500;">Mudar Senha</button>\n                <label style="display: flex; align-items: center; margin-bottom: 12px;">\n                    <input type="checkbox" id="toggle2FA" ${e.doisFatores ? "checked" : ""} style="margin-right: 8px;">\n                    Ativar Autenticação de Dois Fatores\n                </label>\n            </div>\n            <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">\n                <h4 style="margin: 0 0 12px 0; font-size: 1rem;">Aparência</h4>\n                <button id="themeToggleDropdown" style="width: 100%; padding: 10px; background: ${a ? "#e2e8f0" : "var(--primary-gradient)"}; color: ${a ? "#2d3748" : "white"}; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 500; transition: all var(--transition-fast);">${a ? "Mudar para Light Mode" : "Mudar para Dark Mode"}</button>\n            </div>\n            <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">\n                <button id="btnLogout" style="width: 100%; margin-bottom: 12px; padding: 10px; background: #f56565; color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 500;">Logout</button>\n            </div>\n        ` } catch (e) { console.error("[MINHA CONTA] Erro ao carregar dados:", e), o.innerHTML = `\n            <div style="padding: 20px;">\n                <h3 style="margin: 0 0 12px 0; font-size: 1.1rem;">Minha Conta</h3>\n                <p style="margin: 0; color: #f56565;">Erro ao carregar dados: ${e.message}</p>\n                <button id="btnLogout" style="width: 100%; margin-top: 16px; padding: 10px; background: #f56565; color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 500;">Logout</button>\n            </div>\n        ` } document.body.appendChild(o); const a = document.getElementById("inputFotoPerfil"), n = document.getElementById("btnUploadFoto"); a && n && (a.addEventListener("change", previewFotoPerfil), n.addEventListener("click", uploadFotoPerfil)); const r = document.getElementById("fotoPerfilContainer"), i = document.getElementById("editPencilOverlay"); r && i && (r.addEventListener("mouseenter", (() => { i.style.opacity = "1", i.style.display = "flex" })), r.addEventListener("mouseleave", (() => { i.style.opacity = "0" })), i.addEventListener("click", (e => { e.stopPropagation(), abrirPopupTrocarFoto() }))); const s = e => { o.contains(e.target) || "menu-minha-conta" === e.target.id || (o.remove(), document.removeEventListener("click", s)) }; document.addEventListener("click", s); const c = document.getElementById("btnMudarSenha"); c && c.addEventListener("click", (() => { o.remove(), mostrarPopupMudarSenha() })); const d = document.getElementById("btnLogout"); d && d.addEventListener("click", (() => { sessionStorage.removeItem("loggedIn"), sessionStorage.removeItem("userEmail"), o.remove(), window.location.reload() })); const l = document.getElementById("gameSelectorDropdown"); l && l.addEventListener("change", (async e => { const t = e.target.value; localStorage.setItem("currentGame", t), await carregarUserStatus(); const o = localStorage.getItem("ultimaSecao") || "receitas"; await carregarSecao(o); const a = await safeApi("/games"); l.innerHTML = a.map((e => `<option value="${e}" ${e === t ? "selected" : ""}>${e}</option>`)).join(""), socket.emit("joinGame", t) })); const m = document.getElementById("btnNovoJogoDropdown"); m && m.addEventListener("click", (() => { o.remove(), mostrarPopupNovoJogo() })); const u = document.getElementById("themeToggleDropdown"); u && u.addEventListener("click", (e => { const t = "dark" === (document.body.classList.contains("dark-mode") ? "dark" : "bright") ? "bright" : "dark"; document.body.classList.remove("bright-mode", "dark-mode"), document.body.classList.add(t + "-mode"), localStorage.setItem("themeMode", t), o.remove(), document.removeEventListener("click", s) })); const p = document.getElementById("toggle2FA"); p && p.addEventListener("change", (async () => { const e = p.checked; try { const t = await safeApi("/toggle-2fa", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ enable: e }) }); t.sucesso || (alert(t.erro || "Erro ao atualizar 2FA"), p.checked = !e) } catch (t) { alert("Erro ao atualizar 2FA: " + t.message), p.checked = !e } })); const g = document.getElementById("btnSalvarNome"); g && g.addEventListener("click", (async () => { const e = document.getElementById("editNome"), t = e.value.trim().replace(/^#\d+/, ""); if (!t || !/^[a-zA-Z0-9 ]+$/.test(t) || t.length > 50) mostrarErro("Nome inválido: deve conter apenas letras, números e espaços, com até 50 caracteres."); else try { const o = await safeApi("/update-name", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ newName: t }) }); if (o.sucesso) { const t = await safeApi("/me"); e.value = `#${t.id}${t.nome}`, alert("Nome atualizado com sucesso!") } else mostrarErro(o.erro || "Erro ao atualizar nome") } catch (e) { mostrarErro("Erro ao atualizar nome: " + e.message) } })) } function loadProfilePhotoWithFallback() { const e = document.getElementById("previewFotoPerfil"); if (!e) return; const t = sessionStorage.getItem("userEmail") || "default", o = (new Date).getTime(), a = `/data/${encodeURIComponent(t)}/profile.jpg?${o}`; e.src = a, e.onerror = () => { e.src = "/imagens/default-profile.jpg" } } function previewImage(e, t) { const o = e.target.files[0]; if (o) { const e = new FileReader; e.onload = e => { const o = document.getElementById(t); o && (o.src = e.target.result, o.style.display = "block") }, e.readAsDataURL(o) } } function abrirPopupEditarFoto() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupEditarFoto", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Editar Foto de Perfil</h2>\n        <form id="formEditarFoto">\n            <input type="file" id="inputFotoEditar" accept="image/*" style="margin-bottom: 10px;">\n            <img id="previewFotoEditar" style="max-width: 100px; max-height: 100px; border-radius: 50%; display: none; margin-bottom: 10px;">\n            <button type="submit" id="btnUploadFotoEditar">Salvar Foto</button>\n            <button type="button" id="btnCancelarEditarFoto">Cancelar</button>\n            <p id="erroEditarFoto" style="color: red; display: none;"></p>\n        </form>\n    ', document.body.appendChild(t), loadProfilePhotoWithFallback(), document.getElementById("inputFotoEditar").addEventListener("change", (e => previewImage(e, "previewFotoEditar"))), document.getElementById("formEditarFoto").addEventListener("submit", (async o => { o.preventDefault(); const a = document.getElementById("inputFotoEditar"); if (!a.files[0]) { const e = document.getElementById("erroEditarFoto"); return void (e && (e.textContent = "Selecione uma imagem", e.style.display = "block")) } const n = new FormData; n.append("foto", a.files[0]); try { const o = await fetch(`${API}/upload-foto`, { method: "POST", body: n, credentials: "include" }), a = await o.json(); if (a.sucesso) { t.remove(), e.remove(); const o = document.getElementById("profilePic"); o && (o.src = `${API}/data/${encodeURIComponent(sessionStorage.getItem("effectiveUser") || sessionStorage.getItem("user"))}/profile.jpg?${(new Date).getTime()}`, o.style.display = "block"); const a = document.getElementById("uploadFotoContainer"); a && (a.style.display = "none"); const n = document.getElementById("editPencil"); n && (n.style.display = "block") } else { const e = document.getElementById("erroEditarFoto"); e && (e.textContent = a.erro || "Erro ao fazer upload", e.style.display = "block") } } catch (e) { const t = document.getElementById("erroEditarFoto"); t && (t.textContent = "Erro ao fazer upload", t.style.display = "block") } })), document.getElementById("btnCancelarEditarFoto").addEventListener("click", (() => { t.remove(), e.remove() })) } async function compressAndResizeImage(e) { return new Promise(((t, o) => { const a = new Image; a.onload = () => { const e = document.createElement("canvas"); let o = a.width, n = a.height; const r = 150; o > n ? o > r && (n *= r / o, o = r) : n > r && (o *= r / n, n = r), e.width = o, e.height = n; e.getContext("2d").drawImage(a, 0, 0, o, n), e.toBlob((o => { o.size > 51200 ? e.toBlob((e => { t(e) }), "image/jpeg", .5) : t(o) }), "image/jpeg", .7) }, a.onerror = o, a.src = URL.createObjectURL(e) })) } async function mostrarPopupMudarSenha() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupMudarSenha", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Mudar Senha</h2>\n        <form id="formMudarSenha">\n            <input type="password" id="senhaAtual" placeholder="Senha Atual" required>\n            <p id="erroSenhaAtual" style="color: red; display: none;">Senha atual incorreta</p>\n            <input type="password" id="novaSenha" placeholder="Nova Senha" required>\n            <p id="erroNovaSenha" style="color: red; display: none;">Nova senha é obrigatória</p>\n            <input type="password" id="confirmaNovaSenha" placeholder="Confirmar Nova Senha" required>\n            <p id="erroConfirmaSenha" style="color: red; display: none;">Senhas não coincidem</p>\n            <button type="submit">Salvar</button>\n            <button type="button" id="btnCancelarMudarSenha">Cancelar</button>\n        </form>\n    ', document.body.appendChild(t), document.getElementById("formMudarSenha").addEventListener("submit", (async o => { o.preventDefault(); const a = document.getElementById("senhaAtual").value, n = document.getElementById("novaSenha").value, r = document.getElementById("confirmaNovaSenha").value; document.querySelectorAll("#formMudarSenha input").forEach((e => e.style.border = "1px solid #ccc")), document.querySelectorAll("#formMudarSenha p").forEach((e => e.style.display = "none")); let i = !1; if (a || (document.getElementById("erroSenhaAtual").textContent = "Senha atual é obrigatória", document.getElementById("erroSenhaAtual").style.display = "block", document.getElementById("senhaAtual").style.border = "1px solid red", i = !0), n || (document.getElementById("erroNovaSenha").textContent = "Nova senha é obrigatória", document.getElementById("erroNovaSenha").style.display = "block", document.getElementById("novaSenha").style.border = "1px solid red", i = !0), n !== r && (document.getElementById("erroConfirmaSenha").textContent = "Senhas não coincidem", document.getElementById("erroConfirmaSenha").style.display = "block", document.getElementById("novaSenha").style.border = "1px solid red", document.getElementById("confirmaNovaSenha").style.border = "1px solid red", i = !0), !i) try { const o = await safeApi("/change-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ oldPassword: a, newPassword: n }) }); o.sucesso ? (alert("Senha alterada com sucesso!"), t.remove(), e.remove()) : (document.getElementById("erroSenhaAtual").textContent = o.erro || "Erro ao mudar senha", document.getElementById("erroSenhaAtual").style.display = "block", document.getElementById("senhaAtual").style.border = "1px solid red") } catch (e) { document.getElementById("erroSenhaAtual").textContent = "Erro ao mudar senha", document.getElementById("erroSenhaAtual").style.display = "block", document.getElementById("senhaAtual").style.border = "1px solid red" } })), document.getElementById("btnCancelarMudarSenha").addEventListener("click", (() => { t.remove(), e.remove() })) } function abrirPopupTrocarFoto() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupTrocarFoto", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.borderRadius = "var(--border-radius-xl)", t.style.boxShadow = "var(--shadow-xl)", t.style.zIndex = "1001", t.style.maxWidth = "400px", t.style.width = "90%", t.innerHTML = '\n        <h3 style="margin: 0 0 16px; font-size: 1.1rem;">Trocar Foto de Perfil</h3>\n        <div style="text-align: center; margin-bottom: 16px;">\n            <img id="previewTrocarFoto" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: none; margin-bottom: 12px;">\n            <input type="file" id="inputTrocarFoto" accept="image/*" style="margin-bottom: 12px;">\n        </div>\n        <div style="display: flex; gap: 8px; justify-content: flex-end;">\n            <button id="btnCancelarTrocar" style="padding: 8px 16px; background: #e2e8f0; color: #2d3748; border: none; border-radius: var(--border-radius-sm); cursor: pointer;">Cancelar</button>\n            <button id="btnConfirmarTrocar" style="padding: 8px 16px; background: var(--primary-gradient); color: white; border: none; border-radius: var(--border-radius-sm); cursor: pointer;">Confirmar</button>\n        </div>\n        <p id="erroTrocarFoto" style="color: red; font-size: 0.85rem; margin-top: 8px; display: none;"></p>\n    ', document.body.appendChild(t); const o = document.getElementById("inputTrocarFoto"), a = document.getElementById("previewTrocarFoto"); let n = null; o.addEventListener("change", (e => { const t = e.target.files[0]; if (t) { const e = new FileReader; e.onload = e => { a.src = e.target.result, a.style.display = "block"; const t = new Image; t.src = e.target.result, t.onload = () => { const e = document.createElement("canvas"), o = e.getContext("2d"); e.width = 100, e.height = 100, o.drawImage(t, 0, 0, 100, 100), e.toBlob((e => { n = e }), "image/jpeg", .8) } }, e.readAsDataURL(t) } })), document.getElementById("btnCancelarTrocar").addEventListener("click", (() => { t.remove(), e.remove() })), document.getElementById("btnConfirmarTrocar").addEventListener("click", (async () => { const a = o.files[0]; if (!a) return document.getElementById("erroTrocarFoto").textContent = "Selecione uma imagem", void (document.getElementById("erroTrocarFoto").style.display = "block"); const r = new FormData, i = n || a; r.append("foto", i, "profile.jpg"); try { const o = await fetch(`${API}/upload-foto`, { method: "POST", body: r, credentials: "include" }), a = await o.json(); if (a.sucesso) { const o = document.querySelector("#fotoPerfilImg"); o && (o.src = `${API}/data/${encodeURIComponent(sessionStorage.getItem("userEmail"))}/profile.jpg?${Date.now()}`), t.remove(), e.remove() } else document.getElementById("erroTrocarFoto").textContent = a.erro || "Erro ao fazer upload", document.getElementById("erroTrocarFoto").style.display = "block" } catch (e) { document.getElementById("erroTrocarFoto").textContent = "Erro ao fazer upload: " + e.message, document.getElementById("erroTrocarFoto").style.display = "block" } })) } function criarOverlay() { const e = document.createElement("div"); return e.id = "overlay", e.style.position = "fixed", e.style.top = "0", e.style.left = "0", e.style.width = "100%", e.style.height = "100%", e.style.backgroundColor = "rgba(0, 0, 0, 0.5)", e.style.zIndex = "999", document.body.appendChild(e), e } function mostrarPopupLogin() { const e = criarOverlay(), t = document.createElement("div"); if (t.id = "popupLogin", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Login</h2>\n        <form id="formLogin">\n            <input type="email" id="emailLogin" placeholder="Email" required>\n            <input type="password" id="senhaLogin" placeholder="Senha" required>\n            <div id="recaptcha-login" class="g-recaptcha"></div>\n            <button type="submit">Entrar</button>\n            <button type="button" id="btnCadastrar">Cadastrar-se</button>\n            <p id="erroLogin" style="color: red; display: none;">Usuário ou senha não encontrados</p>\n        </form>\n        <div id="otpSectionLogin" style="display: none;">\n            <p>Código de verificação enviado para o seu email.</p>\n            <input type="text" id="otpLogin" placeholder="Código de 6 dígitos" required maxlength="6">\n            <button id="btnVerifyOtpLogin">Confirmar</button>\n            <p id="erroOtpLogin" style="color: red; display: none;">Código inválido</p>\n        </div>\n    ', document.body.appendChild(t), window.grecaptcha && window.recaptchaLoadedLogin) recaptchaLoadedLogin(); else { const e = document.createElement("script"); e.src = "https://www.google.com/recaptcha/api.js?onload=recaptchaLoadedLogin&render=explicit", e.async = !0, e.defer = !0, document.head.appendChild(e) } window.recaptchaLoadedLogin = () => { window.grecaptcha && document.getElementById("recaptcha-login") && (window.recaptchaWidgetLogin = grecaptcha.render("recaptcha-login", { sitekey: RECAPTCHA_SITE_KEY })) }, document.getElementById("formLogin").addEventListener("submit", (async o => { o.preventDefault(); const a = grecaptcha.getResponse(window.recaptchaWidgetLogin); if (!a) return document.getElementById("erroLogin").textContent = "Por favor, valide o reCAPTCHA.", void (document.getElementById("erroLogin").style.display = "block"); const n = document.getElementById("emailLogin").value, r = document.getElementById("senhaLogin").value; try { const o = await safeApi("/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: n, senha: r, recaptchaToken: a }) }); if ("otp_sent" === o.sucesso) document.getElementById("formLogin").style.display = "none", document.getElementById("otpSectionLogin").style.display = "block", document.getElementById("erroLogin").style.display = "none"; else if (o.sucesso) { sessionStorage.setItem("loggedIn", "true"), sessionStorage.setItem("userEmail", n), t.remove(), e.remove(), initMenu(), await initGames(), await carregarUserStatus(); carregarSecao(localStorage.getItem("ultimaSecao") || "receitas") } else document.getElementById("erroLogin").textContent = o.erro || "Usuário ou senha não encontrados", document.getElementById("erroLogin").style.display = "block", document.getElementById("emailLogin").style.border = "1px solid red", document.getElementById("senhaLogin").style.border = "1px solid red", grecaptcha.reset(window.recaptchaWidgetLogin) } catch (e) { document.getElementById("erroLogin").textContent = "Erro ao fazer login", document.getElementById("erroLogin").style.display = "block", document.getElementById("emailLogin").style.border = "1px solid red", document.getElementById("senhaLogin").style.border = "1px solid red", grecaptcha.reset(window.recaptchaWidgetLogin) } })), document.getElementById("btnVerifyOtpLogin").addEventListener("click", (async () => { const o = document.getElementById("emailLogin").value, a = document.getElementById("otpLogin").value.trim(); if (6 !== a.length || !/^\d{6}$/.test(a)) return document.getElementById("erroOtpLogin").textContent = "Código deve ser 6 dígitos numéricos", void (document.getElementById("erroOtpLogin").style.display = "block"); try { const n = await safeApi("/verify-otp-login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: o, code: a }) }); if (n.sucesso) { sessionStorage.setItem("loggedIn", "true"), sessionStorage.setItem("userEmail", o), t.remove(), e.remove(), initMenu(), await initGames(), await carregarUserStatus(); carregarSecao(localStorage.getItem("ultimaSecao") || "receitas") } else document.getElementById("erroOtpLogin").textContent = n.erro || "Código inválido", document.getElementById("erroOtpLogin").style.display = "block" } catch (e) { document.getElementById("erroOtpLogin").textContent = "Erro ao verificar código", document.getElementById("erroOtpLogin").style.display = "block" } })), document.getElementById("btnCadastrar").addEventListener("click", (() => { t.remove(), e.remove(), mostrarPopupCadastro() })) } function mostrarPopupCadastro() { const e = criarOverlay(), t = document.createElement("div"); if (t.id = "popupCadastro", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Cadastro</h2>\n        <form id="formCadastro">\n            <input type="text" id="nomeCadastro" placeholder="Nome" required>\n            <input type="email" id="emailCadastro" placeholder="Email" required>\n            <input type="password" id="senhaCadastro" placeholder="Senha" required>\n            <input type="password" id="confirmaSenha" placeholder="Confirme sua senha" required>\n            <div id="recaptcha-cadastro" class="g-recaptcha"></div>\n            <button type="submit">Enviar solicitação de acesso</button>\n            <button type="button" id="btnVoltarLogin">Voltar para Login</button>\n            <p id="erroCadastro" style="color: red; display: none;"></p>\n            <p id="mensagemCadastro" style="display: none;">Solicitação enviada</p>\n            <div id="voltarConfirmacao" style="display: none;">\n                <button type="button" id="btnVoltarLoginConfirmacao">Voltar para Login</button>\n            </div>\n        </form>\n        <div id="otpSectionCadastro" style="display: none;">\n            <p>Código de verificação enviado para o seu email.</p>\n            <input type="text" id="otpCadastro" placeholder="Código de 6 dígitos" required maxlength="6">\n            <button id="btnVerifyOtpCadastro">Confirmar</button>\n            <p id="erroOtpCadastro" style="color: red; display: none;">Código inválido</p>\n        </div>\n    ', document.body.appendChild(t), window.grecaptcha && window.recaptchaLoadedCadastro) recaptchaLoadedCadastro(); else { const e = document.createElement("script"); e.src = "https://www.google.com/recaptcha/api.js?onload=recaptchaLoadedCadastro&render=explicit", e.async = !0, e.defer = !0, document.head.appendChild(e) } window.recaptchaLoadedCadastro = () => { window.grecaptcha && document.getElementById("recaptcha-cadastro") && (window.recaptchaWidgetCadastro = grecaptcha.render("recaptcha-cadastro", { sitekey: RECAPTCHA_SITE_KEY })) }, document.getElementById("formCadastro").addEventListener("submit", (async o => { o.preventDefault(); const a = grecaptcha.getResponse(window.recaptchaWidgetCadastro); if (!a) return document.getElementById("erroCadastro").textContent = "Por favor, valide o reCAPTCHA.", void (document.getElementById("erroCadastro").style.display = "block"); const n = document.getElementById("nomeCadastro").value, r = document.getElementById("emailCadastro").value, i = document.getElementById("senhaCadastro").value; if (i !== document.getElementById("confirmaSenha").value) return document.getElementById("erroCadastro").textContent = "Senhas não coincidem", document.getElementById("erroCadastro").style.display = "block", document.getElementById("senhaCadastro").style.border = "1px solid red", document.getElementById("confirmaSenha").style.border = "1px solid red", void grecaptcha.reset(window.recaptchaWidgetCadastro); try { const o = await safeApi("/cadastro", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: n, email: r, senha: i, recaptchaToken: a }) }); "otp_sent" === o.sucesso ? (document.getElementById("formCadastro").style.display = "none", document.getElementById("otpSectionCadastro").style.display = "block", document.getElementById("erroCadastro").style.display = "none") : o.sucesso ? (document.getElementById("formCadastro").querySelectorAll("input, button").forEach((e => e.style.display = "none")), document.getElementById("mensagemCadastro").style.display = "block", document.getElementById("voltarConfirmacao").style.display = "block", setTimeout((() => { t.remove(), e.remove(), mostrarPopupLogin() }), 2e3)) : (document.getElementById("erroCadastro").textContent = o.erro || "Erro ao cadastrar", document.getElementById("erroCadastro").style.display = "block", document.getElementById("emailCadastro").style.border = "1px solid red", grecaptcha.reset(window.recaptchaWidgetCadastro)) } catch (e) { document.getElementById("erroCadastro").textContent = "Erro ao cadastrar", document.getElementById("erroCadastro").style.display = "block", document.getElementById("emailCadastro").style.border = "1px solid red", grecaptcha.reset(window.recaptchaWidgetCadastro) } })), document.getElementById("btnVerifyOtpCadastro").addEventListener("click", (async () => { const o = document.getElementById("emailCadastro").value, a = document.getElementById("otpCadastro").value.trim(); if (6 !== a.length || !/^\d{6}$/.test(a)) return document.getElementById("erroOtpCadastro").textContent = "Código deve ser 6 dígitos numéricos", void (document.getElementById("erroOtpCadastro").style.display = "block"); try { const n = await safeApi("/verify-otp-cadastro", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: o, code: a }) }); n.sucesso ? (document.getElementById("otpSectionCadastro").style.display = "none", document.getElementById("mensagemCadastro").style.display = "block", document.getElementById("voltarConfirmacao").style.display = "block", setTimeout((() => { t.remove(), e.remove(), mostrarPopupLogin() }), 2e3)) : (document.getElementById("erroOtpCadastro").textContent = n.erro || "Código inválido", document.getElementById("erroOtpCadastro").style.display = "block") } catch (e) { document.getElementById("erroOtpCadastro").textContent = "Erro ao verificar código", document.getElementById("erroOtpCadastro").style.display = "block" } })), document.getElementById("btnVoltarLogin").addEventListener("click", (() => { const e = document.getElementById("overlay"); e && e.remove(), t.remove(), mostrarPopupLogin() })), document.getElementById("btnVoltarLoginConfirmacao").addEventListener("click", (() => { const e = document.getElementById("overlay"); e && e.remove(), t.remove(), mostrarPopupLogin() })) }
//! FIM auth.js
function initMenu() { const e = document.querySelector(".menu"); if (!e) return; e.innerHTML = ""; let t = 0;[{ section: "home", text: "Bem vindo!" }].forEach((o => { t++; const a = document.createElement("li"); a.dataset.section = o.section, a.textContent = o.text, a.id = `menuItem${t}`, a.addEventListener("click", (() => carregarSecao(o.section))), e.appendChild(a) })); const o = document.createElement("li"); o.id = "menu-guilda", o.classList.add("menu-item-with-submenu"); const a = document.createElement("span"), n = document.createElement("span"); a.innerHTML = "Guilda", n.classList.add("menu-guilda-SpanArrow"), n.innerHTML = "▼", o.appendChild(a), o.appendChild(n), o.addEventListener("click", toggleGuildaSubmenu), e.appendChild(o); const r = document.createElement("ul"); r.id = "submenu-guilda-inline", r.className = "submenu-guilda-inline", r.style.display = "none"; r.innerHTML = [{ section: "time", text: "Membros" }, { section: "atividadesGuilda", text: "Eventos" }].map((e => `\n        <li onclick="carregarSecao('${e.section}')">${e.text}</li>\n    `)).join(""), o.insertAdjacentElement("afterend", r), "true" === localStorage.getItem("guildaMenuOpen") && toggleGuildaSubmenu(); const i = document.createElement("li"); i.id = "menu-crafting", i.classList.add("menu-item-with-submenu"); const s = document.createElement("span"), c = document.createElement("span"); s.innerHTML = "Crafting", c.classList.add("menu-crafting-SpanArrow"), c.innerHTML = "▼", i.appendChild(s), i.appendChild(c), i.addEventListener("click", toggleCraftingSubmenu), e.appendChild(i); const d = document.createElement("ul"); d.id = "submenu-crafting-inline", d.className = "submenu-crafting-inline", d.style.display = "none"; d.innerHTML = [{ section: "categorias", text: "Categorias" }, { section: "estoque", text: "Componentes e Estoque" }, { section: "receitas", text: "Receitas" }, { section: "farmar", text: "Farmar Receitas Favoritas" }, { section: "roadmap", text: "Roadmap" }].map((e => `\n        <li onclick="carregarSecao('${e.section}')">${e.text}</li>\n    `)).join(""), i.insertAdjacentElement("afterend", d), "true" === localStorage.getItem("craftingMenuOpen") && toggleCraftingSubmenu(); const l = document.createElement("li"); l.id = "menu-minha-conta", l.textContent = "Minha Conta", l.style.marginTop = "auto", l.addEventListener("click", mostrarPopupMinhaConta), e.appendChild(l) } function toggleGuildaSubmenu() { const e = document.getElementById("submenu-guilda-inline"), t = document.querySelector("#menu-guilda span"), o = document.querySelector("#menu-guilda .menu-guilda-SpanArrow"); "block" === e.style.display ? (e.style.display = "none", t.innerHTML = "Guilda", o.innerHTML = "▼", localStorage.setItem("guildaMenuOpen", "false")) : (e.style.display = "block", t.innerHTML = "Guilda", o.innerHTML = "▲", localStorage.setItem("guildaMenuOpen", "true")) } function toggleCraftingSubmenu() { const e = document.getElementById("submenu-crafting-inline"), t = document.querySelector("#menu-crafting span"), o = document.querySelector("#menu-crafting .menu-crafting-SpanArrow"); "block" === e.style.display ? (e.style.display = "none", t.innerHTML = "Crafting", o.innerHTML = "▼", localStorage.setItem("craftingMenuOpen", "false")) : (e.style.display = "block", t.innerHTML = "Crafting", o.innerHTML = "▲", localStorage.setItem("craftingMenuOpen", "true")) } document.addEventListener("DOMContentLoaded", (async () => { const e = localStorage.getItem("themeMode") || "bright"; if (document.body.classList.remove("bright-mode", "dark-mode"), document.body.classList.add(e + "-mode"), sessionStorage.getItem("loggedIn")) { initMenu(); try { if (0 === (await safeApi("/games")).length) { const e = await safeApi("/pendencias"); e.length > 0 ? mostrarPopupPendencias(e) : mostrarPopupNovoJogo() } else { await initGames(), await carregarUserStatus(); carregarSecao(localStorage.getItem("ultimaSecao") || "receitas") } } catch (e) { console.error("Error during init after login:", e), "Acesso negado" === e.message ? (sessionStorage.removeItem("loggedIn"), mostrarPopupLogin()) : mostrarErro("Erro ao inicializar: " + e.message) } } else mostrarPopupLogin(); socket.on("connect", (() => { console.log("[SOCKET.IO] Conectado ao servidor"); const e = localStorage.getItem("currentGame") || "Pax Dei"; socket.emit("joinGame", e) })), socket.on("update", (async e => { console.log("[SOCKET.IO] Atualização recebida:", e); const t = localStorage.getItem("ultimaSecao") || "receitas"; "receitas" === e.type ? ("receitas" === t && await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1), "farmar" === t && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || "", document.getElementById("filtroCategoriaFarmar")?.value || ""), "roadmap" === t && await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1), "arquivados" === t && await carregarArquivados()) : "estoque" === e.type ? ("estoque" === t && await carregarEstoque(document.getElementById("buscaEstoque")?.value || "", document.getElementById("ordemEstoque")?.value || "az"), "farmar" === t && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || "", document.getElementById("filtroCategoriaFarmar")?.value || ""), "roadmap" === t && await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1)) : "componentes" === e.type ? ("componentes" === t && await carregarComponentesLista(document.getElementById("buscaComponentes")?.value || "", document.getElementById("ordemComponentes")?.value || "az", document.getElementById("filtroCategoriaComponentes")?.value || ""), "estoque" === t && await carregarEstoque(document.getElementById("buscaEstoque")?.value || "", document.getElementById("ordemEstoque")?.value || "az"), "farmar" === t && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || "", document.getElementById("filtroCategoriaFarmar")?.value || ""), "roadmap" === t && await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1)) : "categorias" === e.type ? "categorias" === t && await carregarCategoriasLista(document.getElementById("buscaCategorias")?.value || "", document.getElementById("ordemCategorias")?.value || "az") : "log" === e.type ? "estoque" === t && await carregarLog(document.getElementById("buscaLogComponente")?.value || "", document.getElementById("filtroLogUser")?.value || "", document.getElementById("filtroLogData")?.value || "") : "arquivados" === e.type ? "arquivados" === t && await carregarArquivados() : "roadmap" === e.type && "roadmap" === t && await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1) })), socket.on("disconnect", (() => { console.log("[SOCKET.IO] Desconectado do servidor") })), socket.on("teamUpdate", (async e => { console.log("[SOCKET.IO] Atualização de time recebida:", e); const t = localStorage.getItem("currentGame") || "Pax Dei"; if (e.game === t) { await carregarListaTime(), await carregarUserStatus(); const e = localStorage.getItem("ultimaSecao") || "receitas"; await carregarSecao(e) } })) })); const botaoDeMinimizar = document.querySelector("#botaoDeMinimizarMenu"); function minimizarOmenu() { const e = document.querySelector("aside"), t = document.querySelectorAll(".menu li"); e.classList.length < 1 ? (e.classList.add("menulateralMinimizado"), botaoDeMinimizar.style = "left: 80px!important;", botaoDeMinimizar.innerHTML = "▶", t.forEach((e => e.style.display = "none"))) : (e.classList.remove("menulateralMinimizado"), botaoDeMinimizar.style = "left: 280px!important;", botaoDeMinimizar.innerHTML = "◀", t.forEach((e => e.style.removeProperty("display")))) } async function carregarSecao(e) { return localStorage.setItem("ultimaSecao", e), "receitas" === e ? montarReceitas() : "componentes" === e ? montarComponentes() : "estoque" === e ? montarEstoque() : "farmar" === e ? montarFarmar() : "roadmap" === e ? montarRoadmap() : "categorias" === e ? montarCategorias() : "time" === e ? montarTime() : "atividadesGuilda" === e ? montarAtividadesGuilda() : "home" === e ? montarManual() : void (conteudo.innerHTML = '<h1 class="home--titulo-principal">Bem-vindo!</h1>\n<p>Essa aplicação tem como finalidade servir como calculadora e gestão de estoque para qualquer jogo de RPG (aqueles que envolvem craft e coleta de itens)!</p>\n<p>No momento, estamos jogando somente o jogo Pax Dei, por isso, seguem alguns links úteis para o jogo:</p>\n<ul class="home lista-de-recomendacoes">\n    <li><div><a href="https://paxdei.gaming.tools">PAX DEI DATABASE</a></div></li>\n    <li><div><a href="https://paxdei.th.gl">MAPA INTERATIVO</a></div></li>\n</ul>\n<iframe id="mapaIframe" src="https://paxdei.th.gl/" title="Pax Dei Interactive Map" loading="lazy"></iframe>\n<iframe id="paxDeiIframe" src="https://paxdei.gaming.tools/" title="Pax Dei DataBase" loading="lazy"></iframe>') } function montarManual() { conteudo.innerHTML = '\n        <h2>Bem-vindo! Manual de Uso da Ferramenta</h2>\n        <p>Use o filtro abaixo para buscar instruções por palavras-chave. Clique nas setas para expandir as seções.</p>\n        <div class="filtros">\n            <input type="text" id="buscaManual" placeholder="Buscar instruções (ex: \'time\', \'receita\')">\n        </div>\n        <div id="manualConteudo" class="manual-container">\n            \x3c!-- Seções serão geradas dinamicamente abaixo --\x3e\n        </div>\n    '; const e = document.getElementById("manualConteudo");[{ titulo: "Introdução à Ferramenta", itens: ["Esta ferramenta é um gerenciador completo para jogos MMORPG com foco em crafting e coleta de itens. Ela permite criar receitas, gerenciar componentes, rastrear estoque, planejar farms e mais.", "Todas as ações são salvas por jogo (você pode alternar entre jogos no menu em Minha Conta). As configurações (filtros, quantidades) são salvas por jogo.", "A autenticação é obrigatória para acessar as funcionalidades. Após login, você tem acesso total às ferramentas."] }, { titulo: "Sistema de Time e Permissões", itens: ["O sistema de time permite colaborar com outros jogadores. Há três papéis: Fundador (dono do time), Co-fundador (pode editar tudo como o fundador) e Membro (pode visualizar e usar, mas não editar).", "Para adicionar alguém ao time: Vá na aba 'Time', na seção 'Convidar Novo Membro', digite o email e clique 'Convidar'. O convidado recebe uma pendência e pode aceitar/recusar. O convite chega na aba 'Time' do convidado.", "Aceitar convite: Na aba 'Time', na seção 'Pendências de Convite', clique 'Aceitar' para entrar no time do fundador.", "Promover a co-fundador: Na aba 'Time', na lista de associados, clique 'Promover a Co-Fundador' (apenas fundadores podem fazer isso).", "Desvincular/Banir: Na aba 'Time', use os botões 'Desvincular' ou 'Banir' para remover alguém. Banidos não podem se juntar novamente sem desbanimento.", "Sair do time: Na aba 'Time', clique 'Sair do Time' (apenas membros podem sair; fundadores desvinculam outros)."] }, { titulo: "Gerenciando Jogos", itens: ["Para criar um novo jogo: Clique em 'Novo Jogo' (fica em 'Minha Conta'), digite o nome e confirme. Um novo conjunto de arquivos (receitas, estoque etc.) é criado.", "Alternar jogo: Use o seletor de jogos no menu em 'Minha Conta' para mudar entre jogos salvos. As configurações (filtros, quantidades) são salvas por jogo.", "Jogos não são compartilhados automaticamente com os membros do time. Após a criação de um jogo, caso queira liberar sua visualização para o time, acesse a aba 'Time' e marque a opção de compartilhar no jogo desejado. (somente fundadores podem fazer isso)."] }, { titulo: "Gerenciando Componentes", itens: ["Para criar um novo componente: Na aba 'Componentes e Estoque', clique '+ Novo Componente'. Defina nome, categoria, quantidade produzida e materiais associados (outros Componentes cadastrados que façam parte do fluxo de crafting; apenas fundadores/co-fundadores).", "Editar: Clique 'Editar' para alterar (propaga mudanças para receitas, categoria e roadmap automaticamente; apenas fundadores/co-fundadores).", "Excluir: Clique 'Excluir' (remove referências em receitas/arquivados; apenas fundadores/co-fundadores).", "Categorias: Na aba 'Categorias', crie ou exclua categorias para organizar componentes."] }, { titulo: "Gerenciando Receitas", itens: ["Para criar uma nova receita: Na aba 'Receitas', clique '+ Nova Receita'. Digite o nome e adicione componentes com quantidades. (apenas fundadores/co-fundadores).", "Editar/Duplicar: Clique 'Editar' para modificar ou 'Duplicar' para criar uma cópia (útil para variações; apenas fundadores/co-fundadores).", "Favoritar: Clique 'Favoritar' para marcar como favorita (aparece em 'Farmar Receitas Favoritas').", "Concluir: Insira a quantidade desejada e clique 'Concluir' (debitará do estoque automaticamente; apenas fundadores/co-fundadores).", "Arquivar: Clique 'Arquivar' para mover para 'Arquivados' (remove de receitas ativas; apenas fundadores/co-fundadores).", "Visualizar detalhes: Clique na seta ▼ ao lado da receita para ver requisitos de componentes e subcomponentes."] }, { titulo: "Gerenciando Estoque e Log", itens: ["Adicionar/Debitar: Na aba 'Estoque', use o formulário para adicionar ou debitar itens manualmente. O log registra todas as movimentações. (membros somente podem adicionar itens em estoque, mas não debitar).", "Editar item: Clique 'Editar' em um item do estoque para ajustar a quantidade. (somente fundadores/co-fundadores).", "Excluir item: Clique 'Excluir' (remove do estoque e componente; afeta receitas; somente fundadores/co-fundadores).", "Zerar estoque: Clique 'Zerar todo o estoque' (apenas fundadores/co-fundadores).", "Filtrar log: Na seção 'Log de Movimentações', busque por componente, data ou usuário que fez a alteração."] }, { titulo: "Favoritos (O que Farmar?)", itens: ["Marque receitas como favoritas na aba 'Receitas' para vê-las aqui.", "Filtre por receitas selecionadas (checkboxes) ou categorias para ver o que falta farmar.", "Cores indicam status: Verde (suficiente), Amarelo (quase suficiente), Vermelho (falta muito).", "Fabricar: Clique 'Fabricar Tudo' em um componente com subcomponentes (verifica estoque e debita automaticamente)."] }, { titulo: "Roadmap", itens: ["Adicionar: Clique 'Inserir nova receita' e selecione uma receita para adicionar ao plano. (somente fundadores/co-fundadores).", "Reordenar: Use ↑/↓ para mover itens no roadmap. (somente fundadores/co-fundadores).", "Marcar como pronto: Marque o checkbox 'Pronto' para indicar conclusão (filtro para ver só prontas). (somente fundadores/co-fundadores).", "Excluir: Clique 'Excluir'. (somente fundadores/co-fundadores)."] }, { titulo: "Minha Conta", itens: ["Clique em 'Minha Conta' no menu lateral para abrir um dropdown com suas informações pessoais.", "No dropdown, você pode: ver seus dados (ID, nome, email), selecionar o jogo atual, criar novo jogo, mudar senha, alternar entre modo claro/escuro, e fazer logout.", "Mudar senha: Digite a senha atual e a nova (confirmação obrigatória)."] }].forEach((t => { const o = `\n            <div class="manual-section">\n                <button class="manual-dropdown-toggle">▶ ${t.titulo}</button>\n                <div class="manual-dropdown-content" style="display: none;">\n                    ${t.itens.map((e => `<p class="manual-item">${e}</p>`)).join("")}\n                </div>\n            </div>\n        `; e.innerHTML += o })), document.querySelectorAll(".manual-dropdown-toggle").forEach((e => { e.addEventListener("click", (t => { t.preventDefault(), t.stopPropagation(); const o = e.nextElementSibling, a = "none" !== o.style.display; o.style.display = a ? "none" : "block"; const n = e.textContent.substring(2).trim(); e.textContent = a ? "▶ " + n : "▼ " + n })) })); const t = document.getElementById("buscaManual"), o = debounce(filtrarManual, 300); t.addEventListener("input", (() => o(t.value.toLowerCase()))) } function filtrarManual(e) { document.querySelectorAll(".manual-section").forEach((t => { const o = t.querySelector(".manual-dropdown-toggle"), a = t.querySelectorAll(".manual-item"), n = Array.from(a).some((t => t.textContent.toLowerCase().includes(e))), r = o.textContent.toLowerCase().includes(e); if (t.style.display = n || r ? "block" : "none", n || r) { o.nextElementSibling.style.display = "block"; const e = o.textContent.substring(2).trim(); o.textContent = "▼ " + e } })) }
//! INICIO TIME.JS
async function montarTime() { conteudo.innerHTML = '\n        <h2>Membros</h2>\n        <div id="time-lista" class="lista"></div>\n    ', await carregarListaTime() } async function carregarListaTime() { const e = sessionStorage.getItem("userEmail"); let t = isUserFounder(), o = sessionStorage.getItem("effectiveUser") || e; try { const e = await safeApi("/user-status"); t = e.isFounder, o = e.effectiveUser, sessionStorage.setItem("isFounder", e.isFounder.toString()), sessionStorage.setItem("effectiveUser", e.effectiveUser) } catch (e) { console.error("[TIME] Erro ao carregar status do usuário:", e) } const a = document.getElementById("time-lista"); a.innerHTML = ""; let n = '\n        <div class="secao" id="pendencias-secao">\n            <h3>Pendências de Convite</h3>\n            <ul id="pendencias-lista"></ul>\n        </div>\n    '; if (t || (n = `\n            <div class="secao">\n                <h3>Seu Status no Time</h3>\n                <p>Você é membro do time de <strong>${o}</strong>. Contate o fundador para gerenciar membros.</p>\n                <button class="btn-desvincular" onclick="sairDoTime('${o}')">Sair do Time</button>\n            </div>\n        ` + n), t) try { const [t, o, a] = await Promise.all([safeApi("/associacoes"), safeApi("/banidos"), safeApi("/usuarios-disponiveis")]), r = t.filter((t => t.secondary !== e)); r.map((e => e.secondary)), o.map((e => e.banned)), a.filter((e => !e.pendingReceived)); n += `\n                <div class="secao">\n                    <h3>Associados</h3>\n                    <ul>${r.map((e => { const t = "co-founder" === e.role, o = t ? "" : `<button class="btn-permissoes" onclick="mostrarPopupPermissoes('${e.secondary}')">Permissões</button>`; return `\n                            <li class="time-item">\n                                ${e.secondary}\n                                ${t ? '<span style="color: green;"> (Co-Fundador)</span>' : ""}\n                                <button class="btn-promote-cofounder" onclick="toggleCoFounder('${e.secondary}', ${t})">${t ? "Remover Co-Fundador" : "Promover a Co-Fundador"}</button>\n                                ${o}\n                                <button class="btn-desvincular" onclick="desvincularUsuario('${e.secondary}', '${e.role}')">Desvincular</button>\n                                <button class="btn-banir" onclick="banirUsuario('${e.secondary}', '${e.role}')">Banir</button>\n                            </li>\n                        ` })).join("") || "<li>Nenhum associado</li>"}</ul>\n                </div>\n                <div class="secao">\n                    <h3>Convidar Novo Membro</h3>\n                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">\n                        <input type="text" id="inputEmailConvidar" class="input-convidar" placeholder="Digite o email para convidar">\n                        <button id="btnConvidar" class="btn-vincular">Convidar</button>\n                    </div>\n                    <div id="feedbackConvidar" style="font-weight: 500; margin-top: 8px; display: none;"></div>\n                </div>\n                <div class="secao">\n                    <h3>Banidos</h3>\n                    <ul>${o.map((e => `\n                        <li class="time-item">\n                            ${e.banned}\n                            <button class="btn-desbanir" onclick="desbanirUsuario('${e.banned}', '${e.role}')">Desbanir</button>\n                        </li>\n                    `)).join("") || "<li>Nenhum banido</li>"}</ul>\n                </div>\n            `, n += await getSharedGamesSection() } catch (e) { console.error("[TIME] Erro ao carregar lista:", e), n += "<p>Erro ao carregar dados do time.</p>" } if (a.innerHTML = n, await carregarPendencias(), t) { const e = document.getElementById("btnConvidar"), t = document.getElementById("inputEmailConvidar"), o = document.getElementById("feedbackConvidar"); e.addEventListener("click", (async () => { const a = t.value.trim(); a ? await enviarConvidar(a, e, o, t) : showFeedback(o, "Digite um email válido", "error") })) } t && document.querySelectorAll(".toggle-share").forEach((e => { e.addEventListener("change", (async e => { const t = e.target.dataset.game, o = e.target.checked; await toggleShareGame(t, o) })) })) } async function mostrarPopupPermissoes(e) { const t = criarOverlay(), o = document.createElement("div"); o.id = "popupPermissoes", o.style.position = "fixed", o.style.top = "50%", o.style.left = "50%", o.style.transform = "translate(-50%, -50%)", o.style.backgroundColor = "white", o.style.padding = "20px", o.style.zIndex = "1000", o.style.maxHeight = "80vh", o.style.overflowY = "auto", o.innerHTML = `\n        <h2>Permissões para ${e}</h2>\n        <form id="formPermissoes">\n            <h3>Categorias</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="criarCategorias"> Criar Categorias</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="excluirCategorias"> Excluir Categorias</label>\n            <h3>Componentes e Estoque</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="criarComponente"> Criar Componente</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="editarComponente"> Editar Componente</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="excluirComponente"> Excluir Componente</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="debitarEstoque"> Debitar Estoque</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="zerarEstoque"> Zerar Estoque</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="exportarEstoque"> Exportar Estoque</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="importarEstoque"> Importar Estoque</label>\n            <h3>Receitas</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="criarReceitas"> Criar Receitas</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="favoritarReceitas"> Favoritar Receitas</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="concluirReceitas"> Concluir e Arquivar Receitas</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="duplicarReceitas"> Duplicar Receitas</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="editarReceitas"> Editar Receitas</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="excluirArquivados"> Excluir Arquivados</label>\n            <h3>Farmar Receitas Favoritas</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="fabricarComponentes"> Fabricar Componentes</label>\n            <h3>Roadmap</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="criarRoadmap"> Criar Roadmap</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="excluirRoadmap"> Excluir Roadmap</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="reordenarRoadmap"> Reordenar Roadmap</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="marcarProntoRoadmap"> Marcar Pronto Roadmap</label>\n            <h3>Atividades da Guilda</h3>\n            <label><input type="checkbox" class="perm-checkbox" data-key="criarEvento"> Criar Evento</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="editarEvento"> Editar Evento</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="excluirEvento"> Excluir Evento</label>\n            <label><input type="checkbox" class="perm-checkbox" data-key="associarMembrosEvento"> Associar Membros ao Evento</label>           \n            <button type="submit">Salvar</button>\n            <button type="button" id="btnCancelarPermissoes">Cancelar</button>\n        </form>\n    `, document.body.appendChild(o); try { const t = await safeApi("/associacoes"), o = t.find((t => t.secondary === e)).permissao || {}; document.querySelectorAll(".perm-checkbox").forEach((e => { e.checked = o[e.dataset.key] || !1 })) } catch (e) { console.error("[PERMISSOES] Erro ao carregar permissões:", e) } document.getElementById("formPermissoes").addEventListener("submit", (async a => { a.preventDefault(); const n = {}; document.querySelectorAll(".perm-checkbox").forEach((e => { n[e.dataset.key] = e.checked })); try { const a = await safeApi("/set-permissoes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ secondary: e, permissao: n }) }); a.sucesso ? (o.remove(), t.remove(), await carregarListaTime(), emitTeamUpdate()) : alert(a.erro || "Erro ao salvar permissões") } catch (e) { alert("Erro ao salvar permissões: " + e.message) } })), document.getElementById("btnCancelarPermissoes").addEventListener("click", (() => { o.remove(), t.remove() })) } async function getSharedGamesSection() { try { const e = await safeApi("/games"), t = await safeApi("/shared").catch((() => [])); let o = '\n            <div class="secao">\n                <h3>Compartilhar Jogos com Membros</h3>\n                <ul>\n        '; return e.forEach((e => { const a = t.includes(e); o += `\n                <li class="time-item">\n                    ${e}\n                    <label>\n                        Compartilhar: <input type="checkbox" class="toggle-share" data-game="${e}" ${a ? "checked" : ""}>\n                    </label>\n                </li>\n            ` })), o += "</ul></div>", o } catch (e) { return console.error("[SHARED GAMES] Erro ao carregar jogos compartilhados:", e), '<div class="secao"><h3>Compartilhar Jogos com Membros</h3><p>Erro ao carregar dados.</p></div>' } } async function toggleShareGame(e, t) { try { const o = await safeApi("/shared", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ game: e, share: t }) }); o.sucesso ? emitTeamUpdate() : alert(o.erro || "Erro ao atualizar compartilhamento") } catch (e) { console.error("[TOGGLE SHARE] Erro:", e), alert("Erro ao atualizar compartilhamento") } } async function toggleCoFounder(e, t) { if (confirm(`Confirmar ${t ? "remoção de co-fundador" : "promoção a co-fundador"} para ${e}?`)) try { const o = await safeApi("/promote-cofounder", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ secondary: e, promote: !t }) }); o.sucesso ? (await carregarUserStatus(), await carregarListaTime(), emitTeamUpdate()) : alert(o.erro || "Erro ao atualizar co-founder") } catch (e) { console.error("[TOGGLE CO-FOUNDER] Erro:", e), alert("Erro ao atualizar co-founder") } } async function carregarPendencias() { try { const e = await safeApi("/pendencias"), t = document.getElementById("pendencias-lista"); 0 === e.length ? t.innerHTML = "<li>Nenhuma pendência de convite.</li>" : t.innerHTML = e.map((e => `\n                <li class="time-item">\n                    Convite de <strong>${e.from}</strong>\n                    <button class="btn-vincular" onclick="aceitarConvidar('${e.from}')">Aceitar</button>\n                    <button class="btn-desvincular" onclick="recusarConvidar('${e.from}')">Recusar</button>\n                </li>\n            `)).join("") } catch (e) { console.error("[TIME] Erro ao carregar pendências:", e), document.getElementById("pendencias-lista").innerHTML = "<li>Erro ao carregar pendências.</li>" } } function emitTeamUpdate() { const e = localStorage.getItem("currentGame") || "Pax Dei"; socket.emit("teamUpdate", { game: e }) } async function enviarConvidar(e, t = null, o = null, a = null) { if (confirm(`Enviar convite para ${e}?`)) { t && (t.disabled = !0), a && (a.disabled = !0), o && (o.style.display = "none"); try { const n = await safeApi("/enviar-convite", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ to: e }) }); n.sucesso ? (mostrarSucesso("Convite enviado ✅"), a && (a.value = ""), await carregarListaTime(), emitTeamUpdate()) : showFeedback(o, n.erro || "Erro ao enviar convite", "error", t) } catch (e) { console.error("[TIME] Erro ao enviar convite:", e), showFeedback(o, "Erro ao enviar convite", "error", t) } finally { t && setTimeout((() => { t.disabled = !1 }), 3e3), a && setTimeout((() => { a.disabled = !1 }), 3e3) } } } function showFeedback(e, t, o, a = null) { if (e && (e.textContent = t, e.style.display = "block", e.className = `feedback-${o}`, e.style.color = "success" === o ? "#48bb78" : "#f56565"), a) { const e = a.textContent; a.textContent = t, a.style.background = "success" === o ? "linear-gradient(135deg, #38ef7d 0%, #11998e 100%)" : "linear-gradient(135deg, #fc466b 0%, #f56565 100%)", setTimeout((() => { a.textContent = e, a.style.background = "" }), 3e3) } } async function aceitarConvidar(e) { if (confirm(`Aceitar convite de ${e}?`)) try { const t = await safeApi("/aceitar-convite", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ from: e }) }); t.sucesso ? (await carregarListaTime(), window.location.reload(), emitTeamUpdate()) : alert(t.erro || "Erro ao aceitar convite") } catch (e) { console.error("[TIME] Erro ao aceitar convite:", e), alert("Erro ao aceitar convite") } } async function recusarConvidar(e) { if (confirm(`Recusar convite de ${e}?`)) try { const t = await safeApi("/recusar-convite", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ from: e }) }); t.sucesso ? (window.location.reload(), emitTeamUpdate()) : alert(t.erro || "Erro ao recusar convite") } catch (e) { console.error("[TIME] Erro ao recusar convite:", e), alert("Erro ao recusar convite") } } async function sairDoTime(e) { if (confirm(`Sair do time de ${e}?`)) try { const t = await safeApi("/dissociate-as-secondary", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ primary: e }) }); t.sucesso ? (localStorage.removeItem("currentGame"), await carregarListaTime(), window.location.reload(), emitTeamUpdate()) : alert(t.erro || "Erro ao sair do time") } catch (e) { console.error("[TIME] Erro ao sair do time:", e), alert("Erro ao sair do time") } } async function vincularUsuario(e) { if (confirm(`Vincular ${e} ao seu time?`)) try { const t = await safeApi("/associate-self", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ secondary: e }) }); t.sucesso ? await carregarListaTime() : alert(t.erro || "Erro ao vincular usuário") } catch (e) { console.error("[TIME] Erro ao vincular:", e), alert("Erro ao vincular usuário") } } async function desvincularUsuario(e, t) { if (!confirm(`Desvincular ${e} do seu time?`)) return; let o = "/dissociate-self", a = { secondary: e }; "secondary" === t && (o = "/dissociate-as-secondary", a = { primary: e }); try { const e = await safeApi(o, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }); e.sucesso ? (await carregarListaTime(), emitTeamUpdate()) : alert(e.erro || "Erro ao desvincular usuário") } catch (e) { console.error("[TIME] Erro ao desvincular:", e), alert("Erro ao desvincular usuário") } } async function banirUsuario(e, t) { if (!confirm(`Banir ${e} do seu time?`)) return; let o = "/ban-user", a = { secondary: e }; "secondary" === t && (o = "/ban-as-secondary", a = { primary: e }); try { const e = await safeApi(o, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }); e.sucesso ? (await carregarListaTime(), emitTeamUpdate()) : alert(e.erro || "Erro ao banir usuário") } catch (e) { console.error("[TIME] Erro ao banir:", e), alert("Erro ao banir usuário") } } async function desbanirUsuario(e, t) { if (!confirm(`Desbanir ${e}?`)) return; let o = "/unban-user", a = { bannedEmail: e }; "banned" === t && (o = "/unban-as-banned", a = { primary: e }); try { const e = await safeApi(o, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }); e.sucesso ? (await carregarListaTime(), emitTeamUpdate()) : alert(e.erro || "Erro ao desbanir usuário") } catch (e) { console.error("[TIME] Erro ao desbanir:", e), alert("Erro ao desbanir usuário") } }
//! FIM TIME.JS
//! INICIO ATIVIDADESGUILDA.JS
async function montarAtividadesGuilda() { const e = await safeApi("/me"); window.currentUserEmail = e.email, conteudo.innerHTML = '\n        <h2>Eventos</h2>\n        <div class="filtros">\n            <label for="filtroEventos">Filtrar por:</label>\n            <select id="filtroEventos">\n                <option value="proximos">Próximos Eventos</option>\n                <option value="concluidos">Eventos Concluídos</option>\n            </select>\n        </div>\n        <div id="atividades-lista" class="lista"></div>\n    ', await carregarListaEventos(); const t = localStorage.getItem("currentGame") || "Pax Dei"; socket.emit("registerUser", { email: window.currentUserEmail, game: t }), socket.emit("joinGame", t), socket.on("update", (e => { "atividadesGuilda" === e.type && atualizarListaEventos() })), document.getElementById("filtroEventos").addEventListener("change", (async e => { const t = e.target.value; "proximos" === t ? await carregarListaEventos() : "concluidos" === t && await carregarListaEventosConcluidos() })) } async function atualizarListaEventos() { const e = document.getElementById("filtroEventos").value; "proximos" === e ? await carregarListaEventos() : "concluidos" === e && await carregarListaEventosConcluidos() } async function carregarListaEventos() { const e = localStorage.getItem("currentGame") || "Pax Dei", t = window.currentUserEmail, o = document.getElementById("atividades-lista"); o.innerHTML = ""; let a = ""; (hasPermission("criarEvento") || isUserAdmin()) && (a += '\n            <div class="secao">\n                <button class="botaoNovoEvento" onclick="mostrarPopupNovoEvento()">+ Criar Evento</button>\n            </div>\n        '); try { a += `\n            <div class="secao">\n                <h3>Próximos Eventos</h3>\n                <ul>${(await safeApi(`/atividadesGuilda?game=${encodeURIComponent(e)}`)).map((e => gerarHtmlEvento(e, t))).join("") || '<li class="fraseNenhumEvento">Nenhum evento agendado</li>'}</ul>\n            </div>\n        ` } catch (e) { console.error("[ATIVIDADES GUILDA] Erro ao carregar eventos:", e), a += "<p>Erro ao carregar eventos.</p>" } o.innerHTML = a } async function carregarListaEventosConcluidos() { const e = localStorage.getItem("currentGame") || "Pax Dei", t = window.currentUserEmail, o = document.getElementById("atividades-lista"); o.innerHTML = ""; let a = ""; try { a += `\n            <div class="secao">\n                <h3>Eventos Concluídos</h3>\n                <ul>${(await safeApi(`/atividadesGuilda?game=${encodeURIComponent(e)}&concluded=true`)).map((e => gerarHtmlEvento(e, t, !0))).join("") || '<li class="fraseNenhumEvento">Nenhum evento concluído</li>'}</ul>\n            </div>\n        ` } catch (e) { console.error("[ATIVIDADES GUILDA] Erro ao carregar eventos concluídos:", e), a += "<p>Erro ao carregar eventos concluídos.</p>" } o.innerHTML = a } function gerarHtmlEvento(e, t, o = !1) { const a = e.presencas && e.presencas.includes(t), n = e.criador === t, r = (e.membros || []).includes(t), i = isUserAdmin(), s = !a && (r || n || i), c = hasPermission("associarMembrosEvento") || isUserAdmin(); let d = ""; o || !a && !s || (d = `<button class="evento-item--botaoMarcarPresenca" onclick="${a ? "desmarcarPresenca" : "marcarPresenca"}('${e.id}')">${a ? "Desmarcar Presença" : "Marcar Presença"}</button>`); let l = ""; o || !hasPermission("concluirEvento") && !isUserAdmin() || (l = `<button class="evento-item--botaoConcluir" onclick="concluirEvento('${e.id}')">Concluir</button>`); let m = ""; !o && c && (m = `<button class="evento-item--botaoConvidar" onclick="mostrarPopupAssociarMembros('${e.id}')">Convidar Membros</button>`); let u = ""; o || !hasPermission("editarEvento") && !isUserAdmin() || (u = `<button class="evento-item--botaoEditar" onclick="mostrarPopupEditarEvento('${e.id}')">Editar</button>`); let p = ""; (hasPermission("excluirEvento") || isUserAdmin()) && (p = `<button class="evento-item--botaoExcluirEvento" onclick="excluirEvento('${e.id}')">Excluir Evento</button>`); let g = ""; return g = c ? `\n            <ul class="evento-item--membrosConvidados--lista">${e.membros ? e.membros.map((t => `\n                <li class="evento-item--membrosConvidados--item">\n                    ${escapeHtml(t)}\n                    ${o ? "" : `<button class="evento-item--membrosConvidados--item--botaoCancelar" onclick="cancelarConvite('${e.id}', '${t}')">Cancelar Convite</button>`}\n                </li>\n            `)).join("") : "<li>Nenhum</li>"}</ul>\n        ` : e.membros && e.membros.includes(t) ? `\n            <ul class="evento-item--membrosConvidados--lista"><li class="evento-item--membrosConvidados--item">${escapeHtml(t)}</li></ul>\n        ` : '\n            <p class="evento-item--membrosConvidados--avisoNaoConvidado">Você não está convidado para este evento.</p>\n        ', `\n        <li class="evento-item item" data-id="${e.id}">\n            <strong class="evento-item--titulo">${escapeHtml(e.titulo)}</strong>\n            <p class="evento-item--time">${e.data} ${e.horario} (${e.timezone})</p>\n            <p class="evento-item--descricao">${escapeHtml(e.descricao)}</p>\n            <p class="evento-item--aviso">Aviso: ${e.avisoAntes} minutos antes</p>\n            ${m}\n            ${d}\n            ${u}\n            ${p}\n            ${l}\n            <div class="evento-item--listaDePresencaWrapper">Presenças:\n                <ul class="evento-item--listaDePresencaWrapper--lista">${e.presencas ? e.presencas.map((e => `<li class="evento-item--listaDePresencaWrapper--lista--item" data-email="${escapeHtml(e)}">${escapeHtml(e)}</li>`)).join("") : "<li>Nenhuma</li>"}</ul>\n            </div>\n            <div class="evento-item--membrosConvidados--Wrapper">\n                <h4 class="evento-item--membrosConvidados--titulo">Membros Convidados:</h4>\n                ${g}\n            </div>\n        </li>\n    ` } async function concluirEvento(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; if (confirm("Concluir este evento?")) try { const o = await safeApi(`/atividadesGuilda/${e}/concluir?game=${encodeURIComponent(t)}`, { method: "POST" }); o.sucesso ? atualizarListaEventos() : mostrarErro(o.erro || "Erro ao concluir evento") } catch (e) { mostrarErro("Erro ao concluir evento") } } async function cancelarConvite(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei"; if (confirm(`Cancelar convite para ${t}?`)) try { const a = ((await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(o)}`)).membros || []).filter((e => e !== t)), n = await safeApi(`/atividadesGuilda/${e}/membros?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ membros: a }) }); n.sucesso ? atualizarListaEventos() : mostrarErro(n.erro || "Erro ao cancelar convite") } catch (e) { mostrarErro("Erro ao cancelar convite") } } function mostrarPopupNovoEvento() { const e = localStorage.getItem("currentGame") || "Pax Dei", t = Intl.DateTimeFormat().resolvedOptions().timeZone, o = criarOverlay(), a = document.createElement("div"); a.id = "popupNovoEvento", a.style.position = "fixed", a.style.top = "50%", a.style.left = "50%", a.style.transform = "translate(-50%, -50%)", a.style.backgroundColor = "white", a.style.padding = "20px", a.style.zIndex = "1000", a.innerHTML = `\n        <h2>Novo Evento</h2>\n        <form id="formNovoEvento">\n            <label class="fomrNovoEvento-Titulo">Título:</label>\n            <input type="text" id="tituloEvento" placeholder="Título do Evento" required>\n            <label class="fomrNovoEvento-Titulo">Descrição:</label>\n            <textarea id="descricaoEvento" placeholder="Descrição do Evento" required></textarea>\n            <label class="fomrNovoEvento-Titulo">Data do Evento:</label>\n            <input type="date" id="dataEvento" required>\n            <label class="fomrNovoEvento-Titulo">Horário do Evento:</label>\n            <input type="time" id="horarioEvento" required>\n            <label class="fomrNovoEvento-Titulo">Time Zone:</label>\n            <select id="timezoneEvento" disabled>\n                <option value="${t}">${t}</option>\n            </select>\n            <small>Fuso horário detectado automaticamente do seu navegador.</small>\n            <label class="fomrNovoEvento-Titulo">Minutos de atencedência para aviso por e-mail:</label>\n            <input type="number" id="avisoAntes" placeholder="Aviso antes (minutos)" required>\n            <button type="submit">Criar</button>\n            <button type="button" id="btnCancelarNovoEvento">Cancelar</button>\n        </form>\n    `, document.body.appendChild(a), document.getElementById("formNovoEvento").addEventListener("submit", (async t => { t.preventDefault(); const n = document.getElementById("tituloEvento").value, r = document.getElementById("descricaoEvento").value, i = document.getElementById("dataEvento").value, s = document.getElementById("horarioEvento").value, c = document.getElementById("timezoneEvento").value, d = document.getElementById("avisoAntes").value; try { const t = await safeApi(`/atividadesGuilda?game=${encodeURIComponent(e)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ titulo: n, descricao: r, data: i, horario: s, timezone: c, avisoAntes: parseInt(d), criador: window.currentUserEmail }) }); t.sucesso ? (a.remove(), o.remove(), atualizarListaEventos()) : mostrarErro(t.erro || "Erro ao criar evento") } catch (e) { mostrarErro("Erro ao criar evento") } })), document.getElementById("btnCancelarNovoEvento").addEventListener("click", (() => { a.remove(), o.remove() })) } async function mostrarPopupEditarEvento(e) { const t = localStorage.getItem("currentGame") || "Pax Dei", o = Intl.DateTimeFormat().resolvedOptions().timeZone; try { const a = await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`), n = criarOverlay(), r = document.createElement("div"); r.id = "popupEditarEvento", r.style.position = "fixed", r.style.top = "50%", r.style.left = "50%", r.style.transform = "translate(-50%, -50%)", r.style.backgroundColor = "white", r.style.padding = "20px", r.style.zIndex = "1000", r.innerHTML = `\n            <h2>Editar Evento</h2>\n            <form id="formEditarEvento">\n                <label class="formEditarEvento-Titulo">Título:</label>\n                <input type="text" id="tituloEventoEdit" value="${escapeHtml(a.titulo)}" required>\n                <label class="formEditarEvento-Titulo">Descrição:</label>\n                <textarea id="descricaoEventoEdit">${escapeHtml(a.descricao)}</textarea>\n                <label class="formEditarEvento-Titulo">Data do Evento:</label>\n                <input type="date" id="dataEventoEdit" value="${a.data}" required>\n                <label class="formEditarEvento-Titulo">Horário do Evento:</label>\n                <input type="time" id="horarioEventoEdit" value="${a.horario}" required>\n                <label class="formEditarEvento-Titulo">Time Zone:</label>\n                <select id="timezoneEventoEdit" disabled>\n                    <option value="${o}">${o}</option>\n                </select>\n                <small>Fuso horário detectado automaticamente do seu navegador.</small>\n                <label class="formEditarEvento-Titulo">Minutos de atencedência para aviso por e-mail:</label>\n                <input type="number" id="avisoAntesEdit" value="${a.avisoAntes}" required>\n                <button type="submit">Salvar</button>\n                <button type="button" id="btnCancelarEditarEvento">Cancelar</button>\n            </form>\n        `, document.body.appendChild(r), document.getElementById("formEditarEvento").addEventListener("submit", (async o => { o.preventDefault(); const a = document.getElementById("tituloEventoEdit").value, i = document.getElementById("descricaoEventoEdit").value, s = document.getElementById("dataEventoEdit").value, c = document.getElementById("horarioEventoEdit").value, d = document.getElementById("timezoneEventoEdit").value, l = document.getElementById("avisoAntesEdit").value; try { const o = await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ titulo: a, descricao: i, data: s, horario: c, timezone: d, avisoAntes: parseInt(l) }) }); o.sucesso ? (r.remove(), n.remove(), atualizarListaEventos()) : mostrarErro(o.erro || "Erro ao editar evento") } catch (e) { mostrarErro("Erro ao editar evento") } })), document.getElementById("btnCancelarEditarEvento").addEventListener("click", (() => { r.remove(), n.remove() })) } catch (e) { mostrarErro("Erro ao carregar evento para edição") } } async function excluirEvento(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; if (confirm("Excluir este evento?")) try { const o = await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`, { method: "DELETE" }); o.sucesso ? atualizarListaEventos() : mostrarErro(o.erro || "Erro ao excluir evento") } catch (e) { mostrarErro("Erro ao excluir evento") } } async function mostrarPopupAssociarMembros(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; if (hasPermission("associarMembrosEvento") || isUserAdmin()) { try { if ((await safeApi(`/user-status?game=${encodeURIComponent(t)}`)).isFounder) { if (!(await safeApi("/shared")).includes(t)) return void mostrarErro("Este jogo não está compartilhado com membros. Compartilhe-o primeiro para associar membros a eventos.") } } catch (e) { return console.error("[ASSOCIAR MEMBROS] Erro ao verificar compartilhamento:", e), void mostrarErro("Erro ao verificar acesso ao jogo") } try { const [o, a] = await Promise.all([safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`), safeApi("/associacoes")]), n = o.membros || [], r = criarOverlay(), i = document.createElement("div"); i.id = "popupAssociarMembros", i.style.position = "fixed", i.style.top = "50%", i.style.left = "50%", i.style.transform = "translate(-50%, -50%)", i.style.backgroundColor = "white", i.style.padding = "20px", i.style.zIndex = "1000", i.innerHTML = `\n            <h2>Associar Membros ao Evento</h2>\n            <label><input type="checkbox" id="convidarTodosCheckbox"> Convidar Todos</label>\n            <ul>\n                ${a.map((e => `\n                    <li>\n                        <label>\n                            <input type="checkbox" class="membro-checkbox" data-email="${e.secondary}" ${n.includes(e.secondary) ? "checked" : ""}>\n                            ${e.secondary}\n                        </label>\n                    </li>\n                `)).join("")}\n            </ul>\n            <button id="btnSalvarMembros">Salvar</button>\n            <button type="button" id="btnCancelarAssociar">Cancelar</button>\n        `, document.body.appendChild(i), document.getElementById("convidarTodosCheckbox").addEventListener("change", (e => { document.querySelectorAll(".membro-checkbox").forEach((t => t.checked = e.target.checked)) })), document.getElementById("btnSalvarMembros").addEventListener("click", (async () => { const o = []; document.querySelectorAll(".membro-checkbox:checked").forEach((e => { o.push(e.dataset.email) })); try { const a = await safeApi(`/atividadesGuilda/${e}/membros?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ membros: o }) }); a.sucesso ? (i.remove(), r.remove(), atualizarListaEventos()) : mostrarErro(a.erro || "Erro ao associar membros") } catch (e) { mostrarErro("Erro ao associar membros") } })), document.getElementById("btnCancelarAssociar").addEventListener("click", (() => { i.remove(), r.remove() })) } catch (e) { mostrarErro("Erro ao carregar membros") } } else mostrarErro("Sem permissão para associar membros") } async function marcarPresenca(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/atividadesGuilda/${e}/presenca?game=${encodeURIComponent(t)}`, { method: "POST" }); if (o.sucesso) { const o = await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`), a = document.querySelector(`.evento-item[data-id="${e}"]`); a ? a.outerHTML = gerarHtmlEvento(o, window.currentUserEmail) : atualizarListaEventos() } else mostrarErro(o.erro || "Erro ao marcar presença") } catch (e) { mostrarErro("Erro ao marcar presença") } } async function desmarcarPresenca(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/atividadesGuilda/${e}/presenca?game=${encodeURIComponent(t)}`, { method: "DELETE" }); if (o.sucesso) { const o = await safeApi(`/atividadesGuilda/${e}?game=${encodeURIComponent(t)}`), a = document.querySelector(`.evento-item[data-id="${e}"]`); a ? a.outerHTML = gerarHtmlEvento(o, window.currentUserEmail) : atualizarListaEventos() } else mostrarErro(o.erro || "Erro ao desmarcar presença") } catch (e) { mostrarErro("Erro ao desmarcar presença") } }
//! FIM ATIVIDADES GUILDA.JS
//! INICIO RECEITAS.JS
async function montarReceitas() { isUserAdmin(); conteudo.innerHTML = `\n    <h2>Receitas</h2>\n    <div class="filtros">\n        <input type="text" id="buscaReceitas" placeholder="Buscar por nome...">\n        <select id="ordemReceitas">\n            <option value="az">Alfabética A-Z</option>\n            <option value="za">Alfabética Z-A</option>\n        </select>\n        <label><input type="checkbox" id="filtroFavoritas"> Somente Favoritas</label>\n        <select id="modoReceitas">\n            <option value="ativas">Ativas</option>\n            <option value="arquivadas">Arquivadas</option>\n        </select>\n        ${hasPermission("criarReceitas") ? '<button id="btnNovaReceita" class="primary">+ Nova Receita</button>' : ""}\n    </div>\n    <div id="listaReceitas" class="lista"></div>\n    `, hasPermission("criarReceitas") && document.getElementById("btnNovaReceita").addEventListener("click", (() => abrirPopupReceita(null))); const e = document.getElementById("buscaReceitas"), t = document.getElementById("ordemReceitas"), o = document.getElementById("filtroFavoritas"), a = document.getElementById("modoReceitas"), n = localStorage.getItem("currentGame") || "Pax Dei", r = JSON.parse(localStorage.getItem(`receitasFilters_${n}`)) || {}; e.value = r.termoBusca || "", t.value = r.ordem || "az", o.checked = r.onlyFavorites || !1, a.value = r.modo || "ativas"; const i = () => { localStorage.setItem(`receitasFilters_${n}`, JSON.stringify({ termoBusca: e.value, ordem: t.value, onlyFavorites: o.checked, modo: a.value })) }, s = debounce(carregarListaReceitas, 300); e.addEventListener("input", (() => { s(e.value, t.value, o.checked, a.value), i() })), t.addEventListener("change", (() => { s(e.value, t.value, o.checked, a.value), i() })), o.addEventListener("change", (() => { s(e.value, t.value, o.checked, a.value), i() })), a.addEventListener("change", (() => { s(e.value, t.value, o.checked, a.value), i() })), await carregarListaReceitas(e.value, t.value, o.checked, a.value) } async function carregarListaReceitas(e = "", t = "az", o = !1, a = "ativas") { const n = localStorage.getItem("currentGame") || "Pax Dei", r = `recipeQuantities_${n}`; let i = JSON.parse(localStorage.getItem(r)) || {}, s = "ativas" === a ? `/receitas?game=${encodeURIComponent(n)}&order=${t}` : `/arquivados?game=${encodeURIComponent(n)}&order=${t}`; e && (s += `&search=${encodeURIComponent(e)}`), o && (s += "&favoritas=true"), e || o || (s += "&limit=10"); try { let c = await safeApi(s); const d = await safeApi(`/componentes?game=${encodeURIComponent(n)}`), l = await safeApi(`/estoque?game=${encodeURIComponent(n)}`), m = {}; l.forEach((e => { m[e.componente] = e.quantidade || 0 })), e && (c = c.filter((t => t.nome.toLowerCase().includes(e.toLowerCase())))), o && (c = c.filter((e => e.favorita))), c = c.sort(((e, o) => { if (e.favorita !== o.favorita) return o.favorita - e.favorita; const a = e.nome.toLowerCase(), n = o.nome.toLowerCase(); return "az" === t ? a.localeCompare(n) : n.localeCompare(a) })), e || o || (c = c.slice(0, 10)); const u = document.getElementById("listaReceitas"); isUserAdmin(); u.innerHTML = c.filter((e => e.nome)).map((e => { const t = `receita-${e.nome.replace(/\s/g, "-")}`, o = (e.componentes || []).map((e => `${formatQuantity(e.quantidade)} x ${e.nome}`)).join(", "), n = i[e.nome] || 1; let r = "", s = "", c = "", d = "", l = "", m = ""; return "ativas" === a ? (r = hasPermission("concluirReceitas") ? `<button class="btn-concluir" data-receita="${e.nome}">Concluir</button>` : "", s = hasPermission("editarReceitas") ? `<button class="btn-editar" data-nome="${e.nome}">Editar</button>` : "", c = hasPermission("concluirReceitas") ? `<button class="btn-arquivar" data-nome="${e.nome}">Arquivar</button>` : "", d = hasPermission("duplicarReceitas") ? `<button class="btn-duplicar" data-nome="${e.nome}">Duplicar</button>` : "", l = hasPermission("favoritarReceitas") ? `<button class="btn-favoritar ${e.favorita ? "favorita" : ""}" data-nome="${e.nome}">${e.favorita ? "Desfavoritar" : "Favoritar"}</button>` : "") : "arquivadas" === a && (m = hasPermission("excluirArquivados") ? `<button class="btn-excluir" data-nome="${e.nome}">Excluir Permanentemente</button>` : ""), `\n        <div class="item ${e.favorita ? "favorita" : ""}" data-receita="${e.nome}">\n          <div class="receita-header">\n            <div class = "receita-header--container1"><div style="margin-right: 15px;"><strong class= "receita-header--titulo">${e.nome}</strong>\n            ${o ? `<div class="comps-lista">${o}</div>` : ""}\n            ${"ativas" === a ? `<input type="number" class="qtd-desejada" min="0.001" step="any" value="${n}" data-receita="${e.nome}">` : ""}\n            ${"arquivadas" === a && e.arquivadoPor ? `<div class="arquivado-info">Arquivado por: ${e.arquivadoPor} em ${e.dataArquivamento}</div>` : ""}</div>\n            ${"ativas" === a ? `<button class="toggle-detalhes" data-target="${t}-detalhes">▼</button>` : ""}</div><div class="receitas-ButtonContainer">\n            ${r}\n            ${s}\n            ${d}\n            ${l}\n            ${c}\n            ${m}</div>\n          </div>\n          <div class="detalhes" id="${t}-detalhes" style="display:none;"></div>\n        </div>` })).join(""), document.querySelectorAll(".toggle-detalhes").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.target, o = document.getElementById(t); if (!o) return void console.error(`[DETALHES] Elemento com ID ${t} não encontrado`); const a = "none" !== o.style.display; if (o.style.display = a ? "none" : "block", e.textContent = a ? "▼" : "▲", !a) { const t = e.closest(".item"), o = t.dataset.receita, a = Math.max(Number(t.querySelector(".qtd-desejada").value) || .001, .001); await atualizarDetalhes(o, a, d, m), hasPermission("concluirReceitas") && await atualizarBotaoConcluir(o, a, d, m) } })) })), document.querySelectorAll(".qtd-desejada").forEach((e => { e.addEventListener("input", (async () => { const t = e.closest(".item"), o = t.dataset.receita, a = Math.max(Number(e.value) || .001, .001); i[o] = a, localStorage.setItem(r, JSON.stringify(i)); const n = t.querySelector(".detalhes"); n && "none" !== n.style.display && (await atualizarDetalhes(o, a, d, m), hasPermission("concluirReceitas") && await atualizarBotaoConcluir(o, a, d, m)) })) })), hasPermission("concluirReceitas") && (document.querySelectorAll(".btn-concluir").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.receita, o = Math.max(Number(e.closest(".item").querySelector(".qtd-desejada").value) || .001, .001); await concluirReceita(t, o, d, m) })) })), document.querySelectorAll(".btn-arquivar").forEach((e => { e.addEventListener("click", (() => { const t = e.dataset.nome; console.log(`[ARQUIVAR] Botão Arquivar clicado para receita: ${t}`), arquivarReceita(t) })) }))), hasPermission("editarReceitas") && document.querySelectorAll(".btn-editar").forEach((e => { e.addEventListener("click", (() => { const t = e.dataset.nome; console.log(`[EDITAR] Botão Editar clicado para receita: ${t}`), editarReceita(t) })) })), hasPermission("duplicarReceitas") && document.querySelectorAll(".btn-duplicar").forEach((e => { e.addEventListener("click", (() => { const t = e.dataset.nome; console.log(`[DUPLICAR] Botão Duplicar clicado para receita: ${t}`), duplicarReceita(t) })) })), hasPermission("favoritarReceitas") && document.querySelectorAll(".btn-favoritar").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.nome, o = e.classList.contains("favorita"); await toggleFavorita(t, !o) })) })), hasPermission("excluirArquivados") && document.querySelectorAll(".btn-excluir").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.nome; console.log(`[EXCLUIR ARQUIVADA] Botão Excluir clicado para receita arquivada: ${t}`), confirm(`Confirmar exclusão permanente de "${t}"?`) && await excluirArquivada(t) })) })), hasPermission("concluirReceitas") && document.querySelectorAll(".item").forEach((async e => { const t = e.dataset.receita, o = Math.max(Number(e.querySelector(".qtd-desejada").value) || .001, .001); await atualizarBotaoConcluir(t, o, d, m) })) } catch (e) { console.error("[RECEITAS] Erro ao carregar lista:", e); document.getElementById("listaReceitas").innerHTML = "<p>Erro ao carregar receitas.</p>" } } async function toggleFavorita(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei"; try { const a = await safeApi(`/receitas/favoritar?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: e, favorita: t }) }); a.sucesso ? await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1, document.getElementById("modoReceitas")?.value || "ativas") : mostrarErro(a.erro || "Erro ao favoritar receita") } catch (e) { mostrarErro("Erro ao favoritar receita: " + e.message) } } async function arquivarReceita(e) { if (console.log(`[ARQUIVAR] Iniciando arquivamento da receita: ${e}`), !confirm(`Confirmar arquivamento de "${e}"?`)) return void console.log(`[ARQUIVAR] Arquivamento de "${e}" cancelado pelo usuário.`); const t = localStorage.getItem("currentGame") || "Pax Dei", o = `recipeQuantities_${t}`; let a = JSON.parse(localStorage.getItem(o)) || {}; try { const n = await safeApi(`/receitas?game=${encodeURIComponent(t)}`); console.log("[ARQUIVAR] Receitas atuais carregadas:", n); const r = n.findIndex((t => t.nome === e)); if (-1 === r) return console.error(`[ARQUIVAR] Receita "${e}" não encontrada em receitas.json`), void mostrarErro("Receita não encontrada para arquivamento."); const i = n.splice(r, 1)[0]; i.arquivadoPor = sessionStorage.getItem("userEmail"), i.dataArquivamento = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), console.log(`[ARQUIVAR] Removendo receita "${e}" de receitas.json`); const s = await safeApi(`/receitas?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }); if (console.log("[ARQUIVAR] Resposta do servidor (receitas):", s), !s.sucesso) return console.error("[ARQUIVAR] Erro ao salvar receitas.json:", s.erro), void mostrarErro("Erro ao remover receita: " + (s.erro || "Falha desconhecida")); let c = await safeApi(`/arquivados?game=${encodeURIComponent(t)}`).catch((() => [])); console.log("[ARQUIVAR] Arquivados atuais:", c), c.push(i), console.log(`[ARQUIVAR] Adicionando receita "${e}" a arquivados.json`); const d = await safeApi(`/arquivados?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(c) }); if (console.log("[ARQUIVAR] Resposta do servidor (arquivados):", d), !d.sucesso) return console.error("[ARQUIVAR] Erro ao salvar arquivados.json:", d.erro), void mostrarErro("Erro ao arquivar receita: " + (d.erro || "Falha desconhecida")); delete a[e], localStorage.setItem(o, JSON.stringify(a)), console.log(`[ARQUIVAR] Atualizando interface do usuário para receita: ${e}`), await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1, document.getElementById("modoReceitas")?.value || "ativas"), document.getElementById("listaFarmar") && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || ""), console.log(`[ARQUIVAR] Receita "${e}" arquivada com sucesso.`) } catch (t) { console.error(`[ARQUIVAR] Erro ao arquivar receita "${e}":`, t), mostrarErro("Erro ao arquivar receita: " + t.message) } } async function atualizarDetalhes(e, t, o, a, n = !1, r = !1) { const i = localStorage.getItem("currentGame") || "Pax Dei"; try { const s = (await safeApi(`/receitas?game=${encodeURIComponent(i)}`)).find((t => t.nome === e)); if (!s) return void console.error(`[DETALHES] Receita "${e}" não encontrada`); const c = document.querySelector(`[data-receita="${e}"] .detalhes`); if (!c) return void console.error(`[DETALHES] Elemento com detalhes para receita "${e}" não encontrado`); const d = { ...a }; let l = "<ul>", m = 1; for (const e of s.componentes) { const a = e.quantidade * t, i = Math.min(d[e.nome] || 0, a); d[e.nome] = (d[e.nome] || 0) - i; const s = Math.max(0, a - i); let c = ""; c = i >= a ? "comp-verde" : s <= .5 * a ? "comp-amarelo" : "comp-vermelho"; const u = o.find((t => t.nome === e.nome)), p = u && u.associados && u.associados.length > 0; let g = ""; n && p && (g = '<button class="toggle-sub">▶</button>'), l += `\n            <li class="${c}">\n              ${g}\n              ${r ? "" : `<span class="prefix">${m}-</span> `}${e.nome} (Nec: ${formatQuantity(a)}, Disp: ${formatQuantity(i)}, Falta: ${formatQuantity(s)})\n              ${s > 0 ? getComponentChain(e.nome, s, o, d, `${m}.`, n, r) : ""}\n            </li>`, m++ } l += "</ul>", c.innerHTML = l, n && c.querySelectorAll(".toggle-sub").forEach((e => { e.addEventListener("click", (() => { const t = e.closest("li").querySelector("ul"); t && ("none" === t.style.display ? (t.style.display = "block", e.textContent = "▼") : (t.style.display = "none", e.textContent = "▶")) })) })) } catch (t) { console.error(`[DETALHES] Erro ao atualizar detalhes para ${e}:`, t) } } function getComponentChain(e, t, o, a, n = "", r = !1, i = !1) { const s = a[e] || 0; let c = Math.min(s, t); if (a[e] = (a[e] || 0) - c, c >= t) return ""; const d = o.find((t => t.nome === e)); if (!d || !d.associados || 0 === d.associados.length) return ""; let l = ""; r && (l = ' style="display:none;"'); let m = `<ul${l}>`; const u = d.quantidadeProduzida || 1, p = Math.ceil((t - c) / u); let g = 1; return d.associados.forEach((e => { const t = e.quantidade * p; let s = Math.min(a[e.nome] || 0, t); a[e.nome] = (a[e.nome] || 0) - s; const c = Math.max(0, t - s); let d = ""; d = s >= t ? "comp-verde" : c <= .5 * t ? "comp-amarelo" : "comp-vermelho"; const l = o.find((t => t.nome === e.nome)), u = l && l.associados && l.associados.length > 0; let y = ""; r && u && (y = '<button class="toggle-sub">▶</button>'); const v = n.split(".").length - 1; m += `\n        <li class="${d}" style="margin-left: ${20 * v}px;">\n          ${y}\n          ${i ? "" : `<span class="prefix">${n}${g}-</span> `}${e.nome} (Nec: ${formatQuantity(t)}, Disp: ${formatQuantity(s)}, Falta: ${formatQuantity(c)})\n          ${c > 0 ? getComponentChain(e.nome, c, o, a, `${n}${g}.`, r, i) : ""}\n        </li>`, g++ })), m += "</ul>", m } function calculateComponentRequirementsWithRemaining(e, t, o, a, n = null, r = null, i = null) { n && n.set(e, (n.get(e) || 0) + t), r && i && (r.has(e) || r.set(e, new Set), r.get(e).add(i)); let s = {}; const c = a[e] || 0, d = Math.min(c, t); a[e] = c - d, d > 0 && (s[e] = d); const l = t - d; if (l > 0) { const t = o.find((t => t.nome === e)); if (t && t.associados && t.associados.length > 0) { const e = t.quantidadeProduzida || 1, c = Math.ceil(l / e); t.associados.forEach((e => { const t = e.quantidade * c; mergeReq(s, calculateComponentRequirementsWithRemaining(e.nome, t, o, a, n, r, i)) })) } else s[e] = (s[e] || 0) + l } return s } function mergeReq(e, t) { for (const [o, a] of Object.entries(t)) e[o] = (e[o] || 0) + a } async function atualizarBotaoConcluir(e, t, o, a) { const n = localStorage.getItem("currentGame") || "Pax Dei"; try { const r = (await safeApi(`/receitas?game=${encodeURIComponent(n)}`)).find((t => t.nome === e)); if (!r) return void console.error(`[CONCLUIR] Receita "${e}" não encontrada`); const i = { ...a }; let s = {}; r.componentes.forEach((e => { const a = e.quantidade * t, n = calculateComponentRequirementsWithRemaining(e.nome, a, o, i); mergeReq(s, n) })); const c = document.querySelector(`[data-receita="${e}"] .btn-concluir`); if (!c) return; const d = await safeApi(`/estoque?game=${encodeURIComponent(n)}`), l = {}; d.forEach((e => { l[e.componente] = e.quantidade || 0 })); const m = Object.entries(s).every((([e, t]) => (l[e] || 0) >= t)); c.disabled = !m } catch (t) { console.error(`[CONCLUIR] Erro ao atualizar botão para ${e}:`, t) } } async function concluirReceita(e, t, o, a) { console.log(`[CONCLUIR] Iniciando conclusão da receita: ${e}, quantidade: ${t}`); const n = localStorage.getItem("currentGame") || "Pax Dei", r = `recipeQuantities_${n}`; let i = JSON.parse(localStorage.getItem(r)) || {}; try { const s = await safeApi(`/receitas?game=${encodeURIComponent(n)}`); console.log("[CONCLUIR] Receitas recebidas do servidor:", s); const c = s.find((t => t.nome === e)); if (!c) return console.error(`[CONCLUIR] Receita "${e}" não encontrada`), void mostrarErro("Receita não encontrada."); const d = { ...a }; let l = {}; c.componentes.forEach((e => { const a = e.quantidade * t, n = calculateComponentRequirementsWithRemaining(e.nome, a, o, d); mergeReq(l, n) })); if (!Object.entries(l).every((([e, t]) => (void 0 !== a[e] ? a[e] : 0) >= t))) return void mostrarErro("Estoque insuficiente para concluir a receita."); for (const [e, t] of Object.entries(l)) { console.log(`[CONCLUIR] Debitando ${t} de ${e} do estoque`); const o = await safeApi(`/estoque?game=${encodeURIComponent(n)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ componente: e, quantidade: t, operacao: "debitar" }) }); if (!o.sucesso) return void mostrarErro(o.erro || `Erro ao debitar ${e} do estoque.`) } const m = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), u = sessionStorage.getItem("userEmail"), p = Object.entries(l).map((([t, o]) => ({ dataHora: m, componente: t, quantidade: o, operacao: "debitar", origem: `Conclusão de ${e}`, user: u }))); console.log("[CONCLUIR] Registrando no log:", p); if (!(await safeApi(`/log?game=${encodeURIComponent(n)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(p) })).sucesso) return void mostrarErro("Erro ao registrar log."); let g = await safeApi(`/receitas?game=${encodeURIComponent(n)}`); console.log("[CONCLUIR] Receitas atuais antes da remoção:", g); const y = g.findIndex((t => t.nome === e)); if (-1 === y) return console.error(`[CONCLUIR] Receita "${e}" não encontrada para arquivamento`), void mostrarErro("Receita não encontrada para arquivamento."); const v = g.splice(y, 1)[0]; v.arquivadoPor = sessionStorage.getItem("userEmail"), v.dataArquivamento = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), console.log(`[CONCLUIR] Removendo receita "${e}" de receitas.json`), console.log("[CONCLUIR] Receitas após remoção:", g); const E = await safeApi(`/receitas?game=${encodeURIComponent(n)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(g) }); if (console.log("[CONCLUIR] Resposta do servidor (receitas):", E), !E.sucesso) return console.error("[CONCLUIR] Erro ao salvar receitas.json:", E.erro), void mostrarErro("Erro ao remover receita: " + (E.erro || "Falha desconhecida")); let f = await safeApi(`/arquivados?game=${encodeURIComponent(n)}`).catch((() => [])); f.push(v), console.log(`[CONCLUIR] Adicionando receita "${e}" a arquivados.json`); const b = await safeApi(`/arquivados?game=${encodeURIComponent(n)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(f) }); if (console.log("[CONCLUIR] Resposta do servidor (arquivados):", b), !b.sucesso) return console.error("[CONCLUIR] Erro ao salvar arquivados.json:", b.erro), void mostrarErro("Erro ao arquivar receita."); delete i[e], localStorage.setItem(r, JSON.stringify(i)), console.log("[CONCLUIR] Atualizando interface do usuário"); (await safeApi(`/estoque?game=${encodeURIComponent(n)}`)).forEach((e => { a[e.componente] = e.quantidade || 0 })), await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1, document.getElementById("modoReceitas")?.value || "ativas"), await carregarEstoque(), await carregarLog(), document.getElementById("listaFarmar") && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || "") } catch (e) { console.error("[CONCLUIR] Erro ao concluir receita:", e), mostrarErro("Erro ao concluir receita: " + e.message) } } async function editarReceita(e) { console.log(`[EDITAR] Abrindo popup para editar receita: ${e}`), abrirPopupReceita(e) } async function duplicarReceita(e) { console.log(`[DUPLICAR] Iniciando duplicação da receita: ${e}`); const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/receitas?game=${encodeURIComponent(t)}`); if (!o.find((t => t.nome === e))) return console.error(`[DUPLICAR] Receita "${e}" não encontrada`), void mostrarErro("Receita não encontrada para duplicação."); let a = `${e} 1`, n = 1; for (; o.some((e => e.nome === a));)n++, a = `${e} ${n}`; abrirPopupReceita(e, !0, a) } catch (t) { console.error(`[DUPLICAR] Erro ao duplicar receita ${e}:`, t), mostrarErro("Erro ao duplicar receita.") } } async function excluirArquivada(e) { const t = localStorage.getItem("currentGame") || "Pax Dei"; try { let o = await safeApi(`/arquivados?game=${encodeURIComponent(t)}`); const a = o.findIndex((t => t.nome === e)); if (-1 === a) return console.error(`[EXCLUIR ARQUIVADA] Receita "${e}" não encontrada em arquivados.json`), void mostrarErro("Receita não encontrada para exclusão."); o.splice(a, 1); const n = await safeApi(`/arquivados?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }); if (!n.sucesso) return console.error("[EXCLUIR ARQUIVADA] Erro ao salvar arquivados.json:", n.erro), void mostrarErro("Erro ao excluir receita: " + (n.erro || "Falha desconhecida")); const r = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), i = sessionStorage.getItem("userEmail"), s = { dataHora: r, componente: e, quantidade: 0, operacao: "excluir_arquivada", origem: `Exclusão permanente de receita arquivada ${e}`, user: i }; (await safeApi(`/log?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify([s]) })).sucesso || mostrarErro("Erro ao registrar log de exclusão."), await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1, document.getElementById("modoReceitas")?.value || "ativas") } catch (t) { console.error(`[EXCLUIR ARQUIVADA] Erro ao excluir receita "${e}":`, t), mostrarErro("Erro ao excluir receita: " + t.message) } } function abrirPopupReceita(e = null, t = !1, o = null) { const a = document.getElementById("popupReceita"), n = document.getElementById("tituloPopupReceita"), r = document.getElementById("formReceita"), i = document.getElementById("receitaAssociadosContainer"), s = document.getElementById("receitaNome"), c = document.getElementById("inputNomeOriginalReceita"); i.innerHTML = "", s.value = "", c.value = ""; const d = localStorage.getItem("currentGame") || "Pax Dei"; !e || t || hasPermission("editarReceitas") ? (e ? (n.textContent = t ? "Duplicar Receita" : "Editar Receita", safeApi(`/receitas?game=${encodeURIComponent(d)}`).then((n => { const r = n.find((t => t.nome === e)); if (!r) return console.error(`[POPUP] Receita "${e}" não encontrada`), mostrarErro("Receita não encontrada."), void (a.style.display = "none"); s.value = t ? o : r.nome, t || (c.value = r.nome), (r.componentes || []).forEach((e => adicionarLinhaReceita(e))), a.style.display = "flex" })).catch((t => { console.error(`[POPUP] Erro ao carregar receita ${e}:`, t), mostrarErro("Erro ao carregar receita."), a.style.display = "none" }))) : (n.textContent = "Nova Receita", a.style.display = "flex"), document.getElementById("btnAddReceitaAssoc").onclick = () => adicionarLinhaReceita(), r.onsubmit = async e => { e.preventDefault(), console.log("[FORM] Formulário submetido"); const o = s.value.trim(), n = Array.from(i.querySelectorAll(".associado-row")).map((e => ({ nome: e.querySelector(".assoc-nome").value, quantidade: Math.max(Number(e.querySelector(".assoc-qtd").value) || .001, .001) }))).filter((e => e.nome && e.quantidade > 0)); if (console.log("[FORM] Dados coletados:", { nomeVal: o, componentes: n }), !o) return void mostrarErro("Nome da receita é obrigatório."); const r = { nome: o, componentes: n }; console.log("[FORM] Payload enviado:", r); let l = `/receitas?game=${encodeURIComponent(d)}`; try { if (c.value && !t) { const e = await safeApi(`/receitas/editar?game=${encodeURIComponent(d)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nomeOriginal: c.value, ...r }) }); if (console.log("[FORM] Resposta do servidor (edição):", e), !e.sucesso) return void mostrarErro(e.erro || "Erro ao editar receita") } else { const e = await safeApi(l, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(r) }); if (console.log("[FORM] Resposta do servidor (nova receita):", e), !e.sucesso) return void mostrarErro(e.erro || "Erro ao salvar receita") } a.style.display = "none", await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1, document.getElementById("modoReceitas")?.value || "ativas") } catch (e) { console.error("[FORM] Erro no fetch:", e), mostrarErro("Erro ao salvar a receita: " + e.message) } }, document.getElementById("btnCancelarReceita").onclick = () => a.style.display = "none") : alert("Você não tem permissão para editar receitas.") } async function adicionarLinhaReceita(e = {}) { const t = document.getElementById("receitaAssociadosContainer"), o = document.createElement("div"); o.className = "associado-row"; const a = Math.random().toString(36).substring(7), n = localStorage.getItem("currentGame") || "Pax Dei"; try { const t = await safeApi(`/componentes?game=${encodeURIComponent(n)}`); o.innerHTML = `\n      <input type="text" class="assoc-nome" list="assoc-datalist-${a}" value="${e.nome || ""}" placeholder="Digite para buscar..." />\n      <datalist id="assoc-datalist-${a}">\n        ${t.map((e => `<option value="${e.nome}">`)).join("")}\n      </datalist>\n      <input type="number" class="assoc-qtd" min="0.001" step="any" value="${formatQuantity(e.quantidade || .001)}" />\n      <button type="button">❌</button>\n    ` } catch (t) { console.error("[ADICIONAR LINHA] Erro ao carregar componentes:", t), o.innerHTML = `\n      <input type="text" class="assoc-nome" list="assoc-datalist-${a}" value="${e.nome || ""}" placeholder="Digite para buscar..." />\n      <datalist id="assoc-datalist-${a}"></datalist>\n      <input type="number" class="assoc-qtd" min="0.001" step="any" value="${formatQuantity(e.quantidade || .001)}" />\n      <button type="button">❌</button>\n    ` } o.querySelector("button").addEventListener("click", (() => o.remove())), t.appendChild(o) }
//! FIM RECEITAS.JS
async function montarComponentes() { isUserAdmin(); conteudo.innerHTML = `\n    <h2>Componentes</h2>\n    <div class="filtros">\n        <input type="text" id="buscaComponentes" placeholder="Buscar por nome...">\n        <select id="ordemComponentes">\n            <option value="az">Alfabética A-Z</option>\n            <option value="za">Alfabética Z-A</option>\n        </select>\n        <select id="filtroCategoriaComponentes">\n            <option value="">Todas as categorias</option>\n        </select>\n        ${hasPermission("criarComponente") ? '<button id="btnNovoComponente" class="primary">+ Novo Componente</button>' : ""}\n    </div>\n    <div id="lista-componentes" class="lista"></div>\n    `, hasPermission("criarComponente") && document.getElementById("btnNovoComponente").addEventListener("click", (() => abrirPopupComponente())); const e = document.getElementById("buscaComponentes"), t = document.getElementById("ordemComponentes"), o = document.getElementById("filtroCategoriaComponentes"), a = localStorage.getItem("currentGame") || "Pax Dei", n = JSON.parse(localStorage.getItem(`componentesFilters_${a}`)) || {}; e.value = n.termoBusca || "", t.value = n.ordem || "az", o.value = n.categoria || ""; const r = () => { localStorage.setItem(`componentesFilters_${a}`, JSON.stringify({ termoBusca: e.value, ordem: t.value, categoria: o.value })) }, i = debounce(carregarComponentesLista, 300); e.addEventListener("input", (() => { i(e.value, t.value, o.value), r() })), t.addEventListener("change", (() => { i(e.value, t.value, o.value), r() })), o.addEventListener("change", (() => { i(e.value, t.value, o.value), r() })), await carregarComponentesLista(e.value, t.value, o.value), await carregarCategoriasDatalist(), await carregarCategoriasSelect() } async function carregarCategoriasSelect() { const e = localStorage.getItem("currentGame") || "Pax Dei"; try { const t = await safeApi(`/categorias?game=${encodeURIComponent(e)}`), o = document.getElementById("filtroCategoriaComponentes"); o && (o.innerHTML = '<option value="">Todas as categorias</option>' + t.map((e => `<option value="${e}">${e}</option>`)).join("")) } catch (e) { console.error("[CATEGORIAS SELECT] Erro ao carregar categorias:", e) } } async function carregarCategoriasDatalist() { const e = localStorage.getItem("currentGame") || "Pax Dei"; try { const t = await safeApi(`/categorias?game=${encodeURIComponent(e)}`); document.querySelectorAll('datalist[id*="categoriasDatalist"]').forEach((e => { e.innerHTML = t.map((e => `<option value="${e}">`)).join("") })) } catch (e) { console.error("[CATEGORIAS DATALIST] Erro ao carregar categorias:", e) } } async function carregarComponentesLista(e = "", t = "az", o = "") { const a = localStorage.getItem("currentGame") || "Pax Dei"; let n = `/componentes?game=${encodeURIComponent(a)}&order=${t}`; n += e ? `&search=${encodeURIComponent(e)}` : "&limit=10"; try { let e = await safeApi(n); o && (e = e.filter((e => e.categoria === o))); const t = document.getElementById("lista-componentes"); t && (t.innerHTML = e.map((e => { const t = (e.associados || []).map((e => `${formatQuantity(e.quantidade)} x ${e.nome}`)).join(", "), o = hasPermission("editarComponente") ? `<button onclick="abrirPopupComponente('${escapeJsString(e.nome)}')" class="primary">Editar</button>` : "", a = hasPermission("excluirComponente") ? `<button onclick="excluirComponente('${escapeJsString(e.nome)}')" class="warn">Excluir</button>` : ""; return `\n          <div class="item">\n            <div>\n              <strong>${e.nome}</strong> <span class="categoria">(${e.categoria || "—"})</span>\n              <div class="comps-lista">\n                Produz: ${formatQuantity(e.quantidadeProduzida)}${t ? ` • Materiais: ${t}` : ""}\n              </div>\n            </div>\n            <div class="acoes">\n              ${o}\n              ${a}\n            </div>\n          </div>` })).join("")) } catch (e) { console.error("[COMPONENTES] Erro ao carregar lista:", e); const t = document.getElementById("lista-componentes"); t && (t.innerHTML = "<p>Erro ao carregar componentes.</p>") } } async function excluirComponente(e) { if (!hasPermission("excluirComponente")) return void alert("Você não tem permissão para excluir componentes."); if (!confirm(`Confirmar exclusão do componente "${e}"? Isso removerá referências em receitas e estoque.`)) return; const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/componentes/excluir?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: e }) }); o.sucesso ? (await carregarComponentesLista(document.getElementById("buscaComponentes")?.value || "", document.getElementById("ordemComponentes")?.value || "az", document.getElementById("filtroCategoriaComponentes")?.value || ""), document.getElementById("listaEstoque") && await carregarEstoque(), document.getElementById("listaReceitas") && await carregarListaReceitas(), document.getElementById("listaFarmar") && await carregarListaFarmar()) : mostrarErro(o.erro || "Erro ao excluir componente") } catch (e) { mostrarErro("Erro ao excluir componente: " + e.message) } } function escapeJsString(e) { return e.replace(/\\/g, "\\\\").replace(/'/g, "\\'") } function abrirPopupComponente(e = null) { if (e && !hasPermission("editarComponente")) return void alert("Você não tem permissão para editar componentes."); if (!e && !hasPermission("criarComponente")) return void alert("Você não tem permissão para criar componentes."); const t = document.getElementById("popupComponente"), o = document.getElementById("tituloPopup"), a = document.getElementById("formComponente"), n = document.getElementById("associadosContainer"), r = document.getElementById("inputNome"), i = document.getElementById("inputCategoria"), s = document.getElementById("inputQuantidadeProduzida"), c = document.getElementById("inputNomeOriginal"); n.innerHTML = "", r.value = "", i.value = "", s.value = formatQuantity(.001), c.value = ""; const d = localStorage.getItem("currentGame") || "Pax Dei"; e ? (o.textContent = "Editar Componente", safeApi(`/componentes?game=${encodeURIComponent(d)}`).then((o => { const a = o.find((t => t.nome === e)); a && (r.value = a.nome, i.value = a.categoria || "", s.value = formatQuantity(a.quantidadeProduzida || .001), c.value = a.nome, (a.associados || []).forEach((e => adicionarAssociadoRow(e.nome, e.quantidade))), t.style.display = "flex") })).catch((e => { console.error("[POPUP COMPONENTE] Erro ao carregar componente:", e), mostrarErro("Erro ao carregar componente."), t.style.display = "none" }))) : (o.textContent = "Novo Componente", carregarCategoriasDatalist(), t.style.display = "flex"), document.getElementById("btnAddAssociado").onclick = () => adicionarAssociadoRow(), a.onsubmit = async e => { e.preventDefault(); const o = r.value.trim(), a = i.value.trim(), l = Math.max(Number(s.value) || .001, .001), m = Array.from(n.querySelectorAll(".associado-row")).map((e => ({ nome: e.querySelector(".assoc-nome").value, quantidade: Math.max(Number(e.querySelector(".assoc-qtd").value) || .001, .001) }))).filter((e => e.nome && e.quantidade > 0)); if (!o) return mostrarErro("Nome inválido"); const u = { nome: o, categoria: a, associados: m, quantidadeProduzida: l }; let p = `/componentes?game=${encodeURIComponent(d)}`; c.value && (u.nomeOriginal = c.value, p = `/componentes/editar?game=${encodeURIComponent(d)}`); try { const e = await safeApi(p, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(u) }); if (!e.sucesso) return mostrarErro(e.erro || "Erro ao salvar componente"); t.style.display = "none", await carregarComponentesLista(document.getElementById("buscaComponentes")?.value || "", document.getElementById("ordemComponentes")?.value || "az"), await carregarCategoriasDatalist() } catch (e) { mostrarErro("Erro ao salvar componente: " + e.message) } }, document.getElementById("btnCancelarComponente").onclick = () => t.style.display = "none", t.style.display = "flex" } async function adicionarAssociadoRow(e = "", t = "") { const o = document.getElementById("associadosContainer"), a = document.createElement("div"); a.className = "associado-row"; const n = Math.random().toString(36).substring(7), r = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/componentes?game=${encodeURIComponent(r)}`); a.innerHTML = `\n      <input type="text" class="assoc-nome" list="assoc-datalist-${n}" value="${e}" placeholder="Digite para buscar..." />\n      <datalist id="assoc-datalist-${n}">\n        ${o.map((e => `<option value="${e.nome}">`)).join("")}\n      </datalist>\n      <input class="assoc-qtd" type="number" min="0.001" step="any" value="${formatQuantity(t || .001)}" />\n      <button type="button">❌</button>\n    ` } catch (o) { console.error("[ADICIONAR ASSOCIADO] Erro ao carregar componentes:", o), a.innerHTML = `\n      <input type="text" class="assoc-nome" list="assoc-datalist-${n}" value="${e}" placeholder="Digite para buscar..." />\n      <datalist id="assoc-datalist-${n}"></datalist>\n      <input class="assoc-qtd" type="number" min="0.001" step="any" value="${formatQuantity(t || .001)}" />\n      <button type="button">❌</button>\n    ` } a.querySelector("button").addEventListener("click", (() => a.remove())), o.appendChild(a) }
//! INICIO ESTOQUE.JS
async function montarEstoque() { const e = isUserAdmin(); conteudo.innerHTML = `\n    <h2>Componentes e Estoque</h2>\n    <div class="filtros">\n        <h3 class="filtros-label">Filtros:</h3>\n        <input type="text" id="buscaEstoque" placeholder="Buscar por nome...">\n        <select id="ordemEstoque">\n            <option value="az">Alfabética A-Z</option>\n            <option value="za">Alfabética Z-A</option>\n        </select>\n    </div>\n    <div style="display:flex; gap:16px;">\n      <div style="flex:1">\n        <form id="formEstoque">\n        <h3 class="tituloFormEstoque">Atualize o estoque:</h2>\n          <input type="text" id="selectComponenteEstoque" list="componentesDatalist" placeholder="Digite para buscar..." required>\n          <datalist id="componentesDatalist"></datalist>\n          <select id="selectOperacao">\n            <option value="adicionar">Adicionar</option>\n            ${hasPermission("debitarEstoque") || e ? '<option value="debitar">Debitar</option>' : ""}\n          </select>\n          <input id="inputQuantidadeEstoque" type="number" min="0.001" step="any" value="0.001" />\n          <button class="primary" type="submit">Confirmar</button>\n        </form>\n        <div class="estoque--acoes">\n          ${hasPermission("exportarEstoque") ? '<button id="btnExportEstoque" class="primary">Exportar Estoque (XLS)</button>' : ""}\n          ${hasPermission("importarEstoque") ? '<label id="btnImportEstoque" for="fileImportEstoque" class="primary">Importar Estoque (XLS)</label><input type="file" id="fileImportEstoque" accept=".xls,.xlsx" style="display: none;">' : ""}\n          ${hasPermission("zerarEstoque") ? '<button id="btnZerarEstoque" class="warn">Zerar todo o estoque</button>' : ""}\n        </div>\n        ${hasPermission("criarComponente") ? '<button id="btnNovoComponenteEstoque" class="primary">+ Novo Componente</button>' : ""}\n        <div id="listaEstoque" class="lista"></div>\n      </div>\n      <div style="flex:1">\n        <h3 class="estoque--log-de-movimentacoes">Log de Movimentações</h3>\n        <div class="filtros">\n            <input type="text" id="buscaLogComponente" list="logComponentesDatalist" placeholder="Digite componente para buscar...">\n            <datalist id="logComponentesDatalist"></datalist>\n            <input type="text" id="filtroLogUser" list="logUsersDatalist" placeholder="Digite usuário para buscar...">\n            <datalist id="logUsersDatalist"></datalist>\n            <input type="date" id="filtroLogData" placeholder="Selecionar data...">\n            <button id="limparFiltrosLog" class="secondary">Limpar Filtros</button>\n        </div>\n        <div id="logMovimentacoes" class="lista" style="max-height:400px;overflow-y:auto;"></div>\n      </div>\n    </div>\n    `; const t = localStorage.getItem("currentGame") || "Pax Dei"; safeApi(`/componentes?game=${encodeURIComponent(t)}`).then((e => { const t = document.getElementById("componentesDatalist"); t.innerHTML = e.map((e => `<option value="${e.nome}">`)).join(""); const o = document.getElementById("selectComponenteEstoque"); o.addEventListener("input", (() => { const a = o.value.toLowerCase(), n = e.filter((e => e.nome.toLowerCase().includes(a))).map((e => `<option value="${e.nome}">`)); t.innerHTML = n.join("") })) })).catch((e => { console.error("[ESTOQUE DATALIST] Erro ao carregar componentes:", e) })); const o = document.getElementById("buscaEstoque"), a = document.getElementById("ordemEstoque"), n = document.getElementById("buscaLogComponente"), r = document.getElementById("filtroLogUser"), i = document.getElementById("filtroLogData"), s = document.getElementById("limparFiltrosLog"), c = JSON.parse(localStorage.getItem(`estoqueFilters_${t}`)) || {}; o.value = c.termoBuscaEstoque || "", a.value = c.ordemEstoque || "az", n.value = c.termoBuscaLog || "", r.value = c.userLog || "", i.value = c.dataLog || ""; const d = () => { localStorage.setItem(`estoqueFilters_${t}`, JSON.stringify({ termoBuscaEstoque: o.value, ordemEstoque: a.value, termoBuscaLog: n.value, userLog: r.value, dataLog: i.value })) }, l = debounce(carregarEstoque, 300), m = debounce(carregarLog, 300); if (o.addEventListener("input", (() => { l(o.value, a.value), d() })), a.addEventListener("change", (() => { l(o.value, a.value), d() })), safeApi(`/log?game=${encodeURIComponent(t)}`).then((e => { const t = [...new Set(e.map((e => e.componente)).filter(Boolean))], o = document.getElementById("logComponentesDatalist"); o.innerHTML = t.map((e => `<option value="${e}">`)).join(""); const a = [...new Set(e.map((e => e.user)).filter(Boolean))], s = document.getElementById("logUsersDatalist"); s.innerHTML = a.map((e => `<option value="${e}">`)).join(""), n.addEventListener("input", (() => { const e = n.value.toLowerCase(), a = t.filter((t => t.toLowerCase().includes(e))).map((e => `<option value="${e}">`)); o.innerHTML = a.join(""), m(n.value, r.value, i.value), d() })), r.addEventListener("input", (() => { const e = r.value.toLowerCase(), t = a.filter((t => t.toLowerCase().includes(e))).map((e => `<option value="${e}">`)); s.innerHTML = t.join(""), m(n.value, r.value, i.value), d() })) })).catch((e => { console.error("[LOG DATALIST] Erro ao carregar log:", e) })), i.addEventListener("change", (() => { m(n.value, r.value, i.value), d() })), s.addEventListener("click", (() => { n.value = "", r.value = "", i.value = "", carregarLog("", "", ""), d() })), document.getElementById("formEstoque").onsubmit = async e => { e.preventDefault(); const s = document.getElementById("selectComponenteEstoque").value, c = Math.max(Number(document.getElementById("inputQuantidadeEstoque").value) || .001, .001), d = document.getElementById("selectOperacao").value, l = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), m = sessionStorage.getItem("userEmail"); try { const e = await safeApi(`/estoque?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ componente: s, quantidade: c, operacao: d }) }); if (!e.sucesso) return mostrarErro(e.erro || "Erro ao movimentar estoque"); const u = { dataHora: l, componente: s, quantidade: c, operacao: d, origem: "Movimentação manual", user: m }; if (!(await safeApi(`/log?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(u) })).sucesso) return mostrarErro("Erro ao registrar log."); await carregarEstoque(o.value, a.value), await carregarLog(n.value, r.value, i.value) } catch (e) { mostrarErro("Erro ao movimentar estoque: " + e.message) } }, hasPermission("exportarEstoque")) { document.getElementById("btnExportEstoque").addEventListener("click", (async () => { try { const e = [["Componente", "Quantidade"], ...(await safeApi(`/estoque?game=${encodeURIComponent(t)}`)).map((e => [e.componente, e.quantidade]))], o = XLSX.utils.aoa_to_sheet(e), a = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(a, o, "Estoque"), XLSX.writeFile(a, `estoque_${t}_${(new Date).toISOString().split("T")[0]}.xlsx`) } catch (e) { mostrarErro("Erro ao exportar estoque: " + e.message) } })) } if (hasPermission("importarEstoque")) { document.getElementById("fileImportEstoque").addEventListener("change", (async e => { const s = e.target.files[0]; if (!s) return; const c = new FileReader; c.onload = async e => { const s = new Uint8Array(e.target.result), c = XLSX.read(s, { type: "array" }), d = c.SheetNames[0], l = c.Sheets[d], m = XLSX.utils.sheet_to_json(l, { header: 1 }); if (m.length < 2) return void mostrarErro("Arquivo inválido: sem dados."); const u = m[0], p = u.indexOf("Componente"), g = u.indexOf("Quantidade"); if (-1 === p || -1 === g) return void mostrarErro("Arquivo inválido: colunas 'Componente' e 'Quantidade' não encontradas."); const y = m.slice(1).map((e => ({ componente: e[p], novaQuantidade: parseFloat(e[g]) || 0 }))).filter((e => e.componente && !isNaN(e.novaQuantidade))); try { const e = await safeApi(`/estoque/import?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(y) }); e.sucesso ? (mostrarSucesso(`Estoque importado com sucesso! ${e.updated} itens atualizados.`), await carregarEstoque(o.value, a.value), await carregarLog(n.value, r.value, i.value)) : mostrarErro(e.erro || "Erro ao importar estoque.") } catch (e) { mostrarErro("Erro ao importar estoque: " + e.message) } }, c.readAsArrayBuffer(s) })) } const u = document.getElementById("btnZerarEstoque"); if (u && (u.disabled = !hasPermission("zerarEstoque"), u.addEventListener("click", (async () => { if (hasPermission("zerarEstoque")) { if (confirm("Tem certeza que deseja zerar todo o estoque? Essa ação não pode ser desfeita.")) try { const e = await safeApi(`/estoque/zerar?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" } }); e.sucesso ? (await carregarEstoque(o.value, a.value), await carregarLog(n.value, r.value, i.value)) : mostrarErro(e.erro || "Erro ao zerar estoque") } catch (e) { mostrarErro("Erro ao zerar estoque: " + e.message) } } else alert("Você não tem permissão para zerar o estoque.") }))), hasPermission("criarComponente")) { document.getElementById("btnNovoComponenteEstoque").addEventListener("click", (() => abrirPopupComponenteEstoque(!0))) } await carregarEstoque(o.value, a.value), await carregarLog(n.value, r.value, i.value) } function abrirPopupComponenteEstoque(e = !0, t = null, o = 0) { if (!e && !hasPermission("editarComponente")) return void alert("Você não tem permissão para editar componentes."); if (e && !hasPermission("criarComponente")) return void alert("Você não tem permissão para criar componentes."); const a = criarOverlay(), n = document.createElement("div"); n.id = "popupComponenteEstoque", n.style.position = "fixed", n.style.top = "50%", n.style.left = "50%", n.style.transform = "translate(-50%, -50%)", n.style.backgroundColor = "white", n.style.padding = "20px", n.style.zIndex = "1000", n.style.maxHeight = "80vh", n.style.overflowY = "auto"; const r = e ? "Novo Componente" : `Editar Componente: ${t}`; n.innerHTML = `\n        <h2>${r}</h2>\n        <form id="formComponenteEstoque">\n            <label>Nome do Componente:</label>\n            <input type="text" id="inputNomeEstoque" value="${t || ""}" required>\n            <label>Categoria:</label>\n            <input type="text" id="inputCategoriaEstoque" list="categoriasDatalistEstoque" placeholder="Categoria (opcional)">\n            <datalist id="categoriasDatalistEstoque"></datalist>\n            <label>Quantidade Produzida:</label>\n            <input type="number" id="inputQuantidadeProduzidaEstoque" min="0.001" step="any" value="${formatQuantity(.001)}" required>\n            <label>Atualizar quantidade no estoque:</label>\n            <input type="number" id="inputQuantidadeEstoqueInicial" min="0" step="any" value="${formatQuantity(o)}" required>\n            <input type="hidden" id="currentQuantidadeEstoque" value="${o}">\n            <h3>Materiais Associados:</h3>\n            <button type="button" id="btnAddAssociadoEstoque" class="primary">+ Adicionar Material</button>\n            <div id="associadosContainerEstoque"></div>\n            <button type="submit">Salvar</button>\n            <button type="button" id="btnCancelarComponenteEstoque">Cancelar</button>\n            <p id="erroComponenteEstoque" style="color: red; display: none;"></p>\n            <input type="hidden" id="inputNomeOriginalEstoque" value="${t || ""}">\n        </form>\n    `, document.body.appendChild(n); const i = localStorage.getItem("currentGame") || "Pax Dei"; async function s(e = "", t = "") { const o = document.getElementById("associadosContainerEstoque"), a = document.createElement("div"); a.className = "associado-row"; const n = Math.random().toString(36).substring(7); try { const o = await safeApi(`/componentes?game=${encodeURIComponent(i)}`); a.innerHTML = `\n                <input type="text" class="assoc-nome" list="assoc-datalist-estoque-${n}" value="${e}" placeholder="Digite para buscar...">\n                <datalist id="assoc-datalist-estoque-${n}">\n                    ${o.map((e => `<option value="${e.nome}">`)).join("")}\n                </datalist>\n                <input class="assoc-qtd" type="number" min="0.001" step="any" value="${formatQuantity(t || .001)}">\n                <button type="button">❌</button>\n            ` } catch (o) { a.innerHTML = `\n                <input type="text" class="assoc-nome" list="assoc-datalist-estoque-${n}" value="${e}" placeholder="Digite para buscar...">\n                <datalist id="assoc-datalist-estoque-${n}"></datalist>\n                <input class="assoc-qtd" type="number" min="0.001" step="any" value="${formatQuantity(t || .001)}">\n                <button type="button">❌</button>\n            ` } a.querySelector("button").addEventListener("click", (() => a.remove())), o.appendChild(a) } !async function () { try { const e = await safeApi(`/categorias?game=${encodeURIComponent(i)}`); document.getElementById("categoriasDatalistEstoque").innerHTML = e.map((e => `<option value="${e}">`)).join("") } catch (e) { console.error("[CATEGORIAS] Erro:", e) } }(), e || safeApi(`/componentes?game=${encodeURIComponent(i)}`).then((e => { const o = e.find((e => e.nome === t)); o && (document.getElementById("inputQuantidadeProduzidaEstoque").value = formatQuantity(o.quantidadeProduzida || .001), document.getElementById("inputCategoriaEstoque").value = o.categoria || "", (o.associados || []).forEach((e => s(e.nome, e.quantidade)))) })).catch((e => { console.error("[POPUP COMPONENTE ESTOQUE] Erro ao carregar componente:", e), function (e) { const t = document.getElementById("erroComponenteEstoque"); t && (t.textContent = e, t.style.display = "block") }("Erro ao carregar componente.") })), document.getElementById("btnAddAssociadoEstoque").addEventListener("click", (() => s())), document.getElementById("formComponenteEstoque").addEventListener("submit", (async t => { t.preventDefault(); const o = document.getElementById("inputNomeEstoque").value.trim(), r = document.getElementById("inputCategoriaEstoque").value.trim(), s = Math.max(Number(document.getElementById("inputQuantidadeProduzidaEstoque").value) || .001, .001), c = Number(document.getElementById("inputQuantidadeEstoqueInicial").value) || 0, d = Number(document.getElementById("currentQuantidadeEstoque").value) || 0, l = Array.from(document.getElementById("associadosContainerEstoque").querySelectorAll(".associado-row")).map((e => ({ nome: e.querySelector(".assoc-nome").value, quantidade: Math.max(Number(e.querySelector(".assoc-qtd").value) || .001, .001) }))).filter((e => e.nome && e.quantidade > 0)), m = document.getElementById("inputNomeOriginalEstoque").value, u = document.getElementById("erroComponenteEstoque"); if (!o) return u.textContent = "Nome do componente é obrigatório", void (u.style.display = "block"); const p = { nome: o, categoria: r, associados: l, quantidadeProduzida: s }; m && (p.nomeOriginal = m); const g = (new Date).toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" }), y = sessionStorage.getItem("userEmail"); let v = []; try { let t = `/componentes?game=${encodeURIComponent(i)}`; m && (t = `/componentes/editar?game=${encodeURIComponent(i)}`); const s = await safeApi(t, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(p) }); if (!s.sucesso) return u.textContent = s.erro || "Erro ao salvar componente", void (u.style.display = "block"); if (v.push({ dataHora: g, componente: o, quantidade: 0, operacao: e ? "criar" : "editar", origem: e ? "Criação de novo componente" : `Edição de componente (nome: ${m} -> ${o}${r !== (document.getElementById("inputCategoriaEstoque").dataset.original || "") ? `, categoria: ${document.getElementById("inputCategoriaEstoque").dataset.original || "—"} -> ${r || "—"}` : ""})`, user: y }), c !== d) { let t, a; if (c > d ? (t = "adicionar", a = c - d) : c < d ? (t = "debitar", a = d - c) : 0 === c && d > 0 ? (t = "debitar", a = d) : a = 0, a > 0) { const n = await safeApi(`/estoque?game=${encodeURIComponent(i)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ componente: o, quantidade: a, operacao: t }) }); if (!n.sucesso) return u.textContent = n.erro || "Erro ao atualizar estoque", void (u.style.display = "block"); v.push({ dataHora: g, componente: o, quantidade: a, operacao: t, origem: e ? "Estoque inicial para novo componente" : "Atualização de quantidade de estoque", user: y }) } } if (v.length > 0) { const e = await safeApi(`/log?game=${encodeURIComponent(i)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(v) }); e.sucesso || console.error("Erro ao registrar log:", e.erro) } n.remove(), a.remove(), await carregarEstoque(document.getElementById("buscaEstoque")?.value || "", document.getElementById("ordemEstoque")?.value || "az"), await carregarLog(document.getElementById("buscaLogComponente")?.value || "", document.getElementById("filtroLogUser")?.value || "", document.getElementById("filtroLogData")?.value || ""), document.getElementById("lista-componentes") && await carregarComponentesLista(document.getElementById("buscaComponentes")?.value || "", document.getElementById("ordemComponentes")?.value || "az", document.getElementById("filtroCategoriaComponentes")?.value || ""), document.getElementById("listaReceitas") && await carregarListaReceitas(), document.getElementById("listaFarmar") && await carregarListaFarmar() } catch (e) { u.textContent = "Erro ao salvar: " + e.message, u.style.display = "block" } })), document.getElementById("btnCancelarComponenteEstoque").addEventListener("click", (() => { n.remove(), a.remove() })) } async function editarEstoqueItem(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei"; let a = "", n = .001, r = []; try { const t = (await safeApi(`/componentes?game=${encodeURIComponent(o)}`)).find((t => t.nome === e)); t && (a = t.categoria || "", n = t.quantidadeProduzida || .001, r = t.associados || []) } catch (e) { return console.error("[EDITAR ESTOQUE] Erro ao carregar componente:", e), void mostrarErro("Erro ao carregar dados do componente.") } abrirPopupComponenteEstoque(!1, e, t) } async function carregarEstoque(e = "", t = "az") { const o = localStorage.getItem("currentGame") || "Pax Dei"; let a = `/estoque?game=${encodeURIComponent(o)}&order=${t}`; a += e ? `&search=${encodeURIComponent(e)}` : "&limit=10"; try { const e = await safeApi(a), t = document.getElementById("listaEstoque"); t && (t.innerHTML = e.map((e => `<div class = "estoque-item-container"><div class="item"><strong>${e.componente || "(Sem nome)"}</strong> - ${formatQuantity(e.quantidade)}x</div> <button class="primary" onclick="editarEstoqueItem('${escapeJsString(e.componente)}', ${e.quantidade})">Editar</button> ${hasPermission("excluirComponente") ? `<button class="warn" onclick="excluirEstoqueItem('${escapeJsString(e.componente)}')">Excluir</button>` : ""}</div>`)).join("")) } catch (e) { console.error("[ESTOQUE] Erro ao carregar:", e); const t = document.getElementById("listaEstoque"); t && (t.innerHTML = "<p>Erro ao carregar estoque.</p>") } } async function excluirEstoqueItem(e) { if (!hasPermission("excluirComponente")) return void alert("Você não tem permissão para excluir itens do estoque."); if (!confirm(`Confirmar exclusão do item "${e}" do estoque? Isso também excluirá o componente e afetará receitas e outros módulos.`)) return; const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/componentes/excluir?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: e }) }); o.sucesso ? (await carregarEstoque(document.getElementById("buscaEstoque")?.value || "", document.getElementById("ordemEstoque")?.value || "az"), document.getElementById("lista-componentes") && await carregarComponentesLista(document.getElementById("buscaComponentes")?.value || "", document.getElementById("ordemComponentes")?.value || "az", document.getElementById("filtroCategoriaComponentes")?.value || ""), document.getElementById("listaReceitas") && await carregarListaReceitas(document.getElementById("buscaReceitas")?.value || "", document.getElementById("ordemReceitas")?.value || "az", document.getElementById("filtroFavoritas")?.checked || !1), document.getElementById("listaFarmar") && await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || "")) : mostrarErro(o.erro || "Erro ao excluir item do estoque") } catch (e) { mostrarErro("Erro ao excluir item do estoque: " + e.message) } } async function carregarLog(e = "", t = "", o = "") { const a = localStorage.getItem("currentGame") || "Pax Dei"; try { let n = (await safeApi(`/log?game=${encodeURIComponent(a)}`)).reverse(); if (e && (n = n.filter((t => t.componente && t.componente.toLowerCase().includes(e.toLowerCase())))), t && (n = n.filter((e => e.user && e.user.toLowerCase().includes(t.toLowerCase())))), o) { const [e, t, a] = o.split("-"), r = `${a}/${t}/${e}`; n = n.filter((e => e.dataHora && e.dataHora.startsWith(r))) } const r = document.getElementById("logMovimentacoes"); r && (r.innerHTML = n.map((e => { const t = "debitar" === e.operacao ? "-" : "+", o = e.quantidade ?? 0, a = e.componente ?? "(Sem nome)", n = e.dataHora ?? "(Sem data)", r = e.user ? ` por ${e.user}` : "", i = e.origem ? ` (Origem: ${e.origem})` : ""; return `<div class="item"><span>[${n}]</span> ${t}${formatQuantity(o)} x ${a}${r}${i}</div>` })).join("")) } catch (e) { console.error("[LOG] Erro ao carregar:", e); const t = document.getElementById("logMovimentacoes"); t && (t.innerHTML = "<p>Erro ao carregar log.</p>") } }
//! FIM ESTOQUE.JS
async function montarFarmar() { const e = localStorage.getItem("currentGame") || "Pax Dei"; try { const t = await safeApi(`/categorias?game=${encodeURIComponent(e)}`), o = (await safeApi(`/receitas?game=${encodeURIComponent(e)}&limit=9999`)).filter((e => e.favorita)); conteudo.innerHTML = `\n        <h2>O Que farmar?</h2>\n        <div id="suggestedSequence">\n            <h3>Sequência Sugerida</h3>\n            <ol id="sequenceList"></ol>\n        </div>\n        <div class="filtros">\n            <input type="text" id="buscaFarmar" placeholder="Buscar por matéria prima...">\n            <div class="multi-select-wrapper">\n                <div id="filtroReceitaFarmar" class="dropdown-checkbox">\n                    <input type="text" id="searchReceitaFarmar" placeholder="Filtrar receitas...">\n                    <ul id="listaReceitasFarmar"></ul>\n                </div>\n                <span id="selectedBadge" class="badge green">0</span>\n                <span id="unselectedBadge" class="badge red">${o.length}</span>\n            </div>\n            <select id="filtroCategoriaFarmar">\n                <option value="">Todas as categorias</option>\n                ${t.map((e => `<option value="${e}">${e}</option>`)).join("")}\n            </select>\n            <select id="ordemFarmar">\n                <option value="pendente-desc">Pendente Maior-Menor</option>\n                <option value="pendente-asc">Pendente Menor-Maior</option>\n                <option value="az">Alfabética A-Z</option>\n                <option value="za">Alfabética Z-A</option>\n            </select>\n            <button id="limparFiltrosFarmar" class="secondary">Limpar Filtros</button>\n        </div>\n        <div id="listaFarmar" class="lista"></div>\n        `; const a = document.getElementById("buscaFarmar"), n = document.getElementById("filtroReceitaFarmar"), r = document.getElementById("searchReceitaFarmar"), i = document.getElementById("listaReceitasFarmar"), s = document.getElementById("selectedBadge"), c = document.getElementById("unselectedBadge"), d = document.getElementById("filtroCategoriaFarmar"), l = document.getElementById("ordemFarmar"), m = document.getElementById("limparFiltrosFarmar"), u = JSON.parse(localStorage.getItem(`farmarFilters_${e}`)) || {}; a.value = u.termoBusca || "", l.value = u.ordem || "pendente-desc", d.value = u.categoria || "", o.forEach((e => { const t = document.createElement("li"); t.innerHTML = `\n                <label>\n                    <input type="checkbox" value="${e.nome}">\n                    ${e.nome}\n                </label>\n            `, i.appendChild(t) })); const p = u.selectedReceitas || []; Array.from(i.querySelectorAll('input[type="checkbox"]')).forEach((e => { e.checked = p.includes(e.value) })); const g = () => { const e = o.length, t = i.querySelectorAll('input[type="checkbox"]:checked').length; s.textContent = t, c.textContent = e - t }; g(); const y = () => { const t = Array.from(i.querySelectorAll('input[type="checkbox"]:checked')).map((e => e.value)); localStorage.setItem(`farmarFilters_${e}`, JSON.stringify({ termoBusca: a.value, ordem: l.value, categoria: d.value, selectedReceitas: t })) }; r.addEventListener("focus", (() => { i.style.display = "block" })), document.addEventListener("click", (e => { n.contains(e.target) || (i.style.display = "none") })), r.addEventListener("input", (() => { const e = r.value.toLowerCase(); Array.from(i.children).forEach((t => { const o = t.textContent.toLowerCase(); t.style.display = o.includes(e) ? "block" : "none" })) })), i.addEventListener("change", (async () => { g(); const e = Array.from(i.querySelectorAll('input[type="checkbox"]:checked')).map((e => e.value)); await updateCategoriaFilterOptions(a.value, e), await carregarListaFarmar(a.value, l.value, "", d.value), y() })); const v = debounce(carregarListaFarmar, 300); a.addEventListener("input", (async () => { const e = Array.from(i.querySelectorAll('input[type="checkbox"]:checked')).map((e => e.value)); await updateCategoriaFilterOptions(a.value, e), await v(a.value, l.value, "", d.value), y() })), d.addEventListener("change", (async () => { await v(a.value, l.value, "", d.value), y() })), l.addEventListener("change", (async () => { await v(a.value, l.value, "", d.value), y() })), m.addEventListener("click", (async () => { a.value = "", r.value = "", Array.from(i.querySelectorAll('input[type="checkbox"]')).forEach((e => e.checked = !1)), g(), d.value = "", l.value = "pendente-desc", await updateCategoriaFilterOptions("", []), await carregarListaFarmar("", "pendente-desc", "", ""), y() })); const E = Array.from(i.querySelectorAll('input[type="checkbox"]:checked')).map((e => e.value)); await updateCategoriaFilterOptions("", E), await carregarListaFarmar(a.value, l.value, "", d.value) } catch (e) { console.error("[FARMAR] Erro ao montar:", e), conteudo.innerHTML = "<h2>Favoritos</h2><p>Erro ao carregar dados.</p>" } } function calculateComponentRequirements(e, t, o) { let a = {}; const n = o.find((t => t.nome === e)); if (n && n.associados && n.associados.length > 0) { const e = n.quantidadeProduzida || 1, r = Math.ceil(t / e); for (const e of n.associados) { const t = e.quantidade * r; mergeReq(a, calculateComponentRequirements(e.nome, t, o)) } } else a[e] = (a[e] || 0) + t; return a } async function updateCategoriaFilterOptions(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei", a = `recipeQuantities_${o}`; JSON.parse(localStorage.getItem(a)); try { const e = (await safeApi(`/receitas?game=${encodeURIComponent(o)}&limit=9999`)).filter((e => e.favorita)), a = await safeApi(`/componentes?game=${encodeURIComponent(o)}&limit=9999`), n = (await safeApi(`/estoque?game=${encodeURIComponent(o)}&limit=9999`), t.length > 0 ? e.filter((e => t.includes(e.nome))) : e), r = new Set; for (const e of n) e.componentes.forEach((e => { collectCategories(e.nome, a, r) })); const i = [...r].filter((e => e)).sort(), s = document.getElementById("filtroCategoriaFarmar"); if (s) { const e = s.value; s.innerHTML = '<option value="">Todas as categorias</option>' + i.map((e => `<option value="${e}">${e}</option>`)).join(""), e && !i.includes(e) ? s.value = "" : s.value = e } } catch (e) { console.error("[UPDATE CATEGORIA OPTIONS] Erro:", e) } } async function carregarListaFarmar(e = "", t = "pendente-desc", o = "", a = "") { if (!document.getElementById("listaFarmar")) return void console.log("[FARMAR] Seção não encontrada, pulando atualização."); const n = localStorage.getItem("currentGame") || "Pax Dei", r = `recipeQuantities_${n}`, i = JSON.parse(localStorage.getItem(r)) || {}; try { const o = (await safeApi(`/receitas?game=${encodeURIComponent(n)}&limit=9999`)).filter((e => e.favorita)), r = await safeApi(`/componentes?game=${encodeURIComponent(n)}&limit=9999`), s = await safeApi(`/estoque?game=${encodeURIComponent(n)}&limit=9999`), c = Array.from(document.querySelectorAll('#listaReceitasFarmar input[type="checkbox"]:checked')).map((e => e.value)), d = c.length > 0 ? o.filter((e => c.includes(e.nome))) : o, l = {}; s.forEach((e => { l[e.componente] = e.quantidade || 0 })); const m = { ...l }, u = new Map, p = new Map; for (const e of d) { if (!e.nome) continue; const t = i[e.nome] || 1; e.componentes.forEach((o => { const a = o.quantidade * t; calculateComponentRequirementsWithRemaining(o.nome, a, r, m, u, p, e.nome) })) } let g = Array.from(u.keys()).map((e => { const t = u.get(e), o = l[e] || 0; return { nome: e, nec: t, disp: o, pendente: Math.max(0, t - o), receitas: Array.from(p.get(e) || []) } })); g = filtrarItens(g, e, "nome"), a && (g = g.filter((e => { const t = r.find((t => t.nome === e.nome)); return t && t.categoria === a }))), "pendente-desc" === t ? g.sort(((e, t) => t.pendente - e.pendente)) : "pendente-asc" === t ? g.sort(((e, t) => e.pendente - t.pendente)) : g = ordenarItens(g, t, "nome"); const y = document.getElementById("listaFarmar"); y ? (y.innerHTML = g.map((e => { const t = e.disp / e.nec * 100 || 0; let o = "darkred"; t >= 100 ? o = "darkgreen" : t >= 50 && (o = "darkgoldenrod"); const a = `farmar-${e.nome.replace(/\s/g, "-")}`, n = r.find((t => t.nome === e.nome)), i = n && n.associados && n.associados.length > 0, s = hasPermission("fabricarComponentes") && i ? `<button class="btn-fabricar" data-componente="${e.nome}" data-pendente="${e.pendente}" data-qtdprod="${n.quantidadeProduzida || 1}">Fabricar Tudo</button>` : ""; return `\n                <div class="item" style="background-color: ${o}; color: white;" data-componente="${e.nome}">\n                    <div class="comp-item">\n                        <span class="comp-nome">${e.nome}</span>\n                        <span class="comp-nec">Nec: ${formatQuantity(e.nec)}</span>\n                        <span class="comp-disp">Disp: ${formatQuantity(e.disp)}</span>\n                        <span class="comp-falta">Pendente: ${formatQuantity(e.pendente)}</span>\n                    </div>\n                    <select class="receitas-dropdown">\n                        <option>Receitas (${e.receitas.length})</option>\n                        ${e.receitas.sort().map((e => `<option>${e}</option>`)).join("")}\n                    </select>\n                    ${i ? `<button class="toggle-detalhes" data-target="${a}-detalhes">▼</button>` : ""}\n                    <div class="detalhes" id="${a}-detalhes" style="display:none;"></div>\n                    ${s}\n                    <button class="btn-atualizar-estoque" data-componente="${e.nome}">Atualizar Estoque</button>\n                    <div class="atualizar-estoque-input" id="update-${a}" style="display:none;">\n                        <input type="number" class="input-nova-qtd" data-componente="${e.nome}" value="${formatQuantity(e.disp)}" min="0">\n                        <button class="btn-save-stock">Salvar</button>\n                        <button class="btn-cancel-stock">Cancelar</button>\n                    </div>\n                </div>\n            ` })).join(""), document.querySelectorAll("#listaFarmar .toggle-detalhes").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.target, o = document.getElementById(t), a = "none" !== o.style.display; if (o.style.display = a ? "none" : "block", e.textContent = a ? "▼" : "▲", !a) { const t = e.closest(".item").dataset.componente, a = g.find((e => e.nome === t)); if (a) { const e = { ...l }; o.innerHTML = `<ul>${getComponentChain(a.nome, a.nec, r, e)}</ul>` } } })) })), hasPermission("fabricarComponentes") && (document.querySelectorAll("#listaFarmar .item").forEach((async e => { const t = e.dataset.componente, o = r.find((e => e.nome === t)); if (o && o.associados && o.associados.length > 0) { let a = o.quantidadeProduzida || 1; const n = g.find((e => e.nome === t)); let r = n ? n.pendente : 0, i = Math.ceil(r / a), s = r > 0; if (s) for (const e of o.associados) { if ((l[e.nome] || 0) < e.quantidade * i) { s = !1; break } } const c = e.querySelector(".btn-fabricar"); c && (c.disabled = !s) } })), document.querySelectorAll("#listaFarmar .btn-fabricar").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.componente, o = parseFloat(e.dataset.pendente), a = parseFloat(e.dataset.qtdprod), n = Math.ceil(o / a); await fabricarComponente(t, n), e.disabled = !0 })) }))), document.querySelectorAll("#listaFarmar .btn-atualizar-estoque").forEach((e => { e.addEventListener("click", (e => { const t = e.target.closest(".item").dataset.componente, o = document.getElementById(`update-farmar-${t.replace(/\s/g, "-")}`); o.style.display = "flex"; const a = o.querySelector(".input-nova-qtd"); a.focus(), a.select() })) })), document.querySelectorAll("#listaFarmar .btn-save-stock").forEach((e => { e.addEventListener("click", (async () => { const t = e.closest(".atualizar-estoque-input"), o = t.querySelector(".input-nova-qtd"), a = o.dataset.componente, n = parseFloat(o.value); isNaN(n) || n < 0 ? alert("Quantidade inválida") : (t.style.display = "none", await atualizarEstoqueComponente(a, n)) })) })), document.querySelectorAll("#listaFarmar .btn-cancel-stock").forEach((e => { e.addEventListener("click", (() => { e.closest(".atualizar-estoque-input").style.display = "none" })) })), document.querySelectorAll("#listaFarmar .input-nova-qtd").forEach((e => { e.addEventListener("keydown", (async e => { if ("Enter" === e.key) { const t = e.target.closest(".atualizar-estoque-input"), o = e.target.dataset.componente, a = parseFloat(e.target.value); if (isNaN(a) || a < 0) return void alert("Quantidade inválida"); t.style.display = "none", await atualizarEstoqueComponente(o, a) } })) }))) : console.log("[FARMAR] Skip updating farmar list as div not found."); let v = g.filter((e => e.pendente > 0)); if (v.length > 0) { renderSequence(getSuggestedSequence(r, v), v, r) } else document.getElementById("sequenceList").innerHTML = "<li>Nenhuma sequência sugerida disponível.</li>" } catch (e) { console.error("[FARMAR LISTA] Erro ao carregar:", e); const t = document.getElementById("listaFarmar"); t && (t.innerHTML = "<p>Erro ao carregar favoritos.</p>") } } function getSuggestedSequence(e, t) { const o = `suggestedSequence_${localStorage.getItem("currentGame") || "Pax Dei"}`, a = localStorage.getItem(o); if (a) try { const o = JSON.parse(a).filter((e => t.some((t => t.nome === e)))); if (o.length === t.length) return o.map((t => { const o = e.find((e => e.nome === t)); return { nome: t, hasSubs: o && o.associados && o.associados.length > 0 } })) } catch (e) { console.error("[SUGGESTED SEQUENCE] Erro ao carregar sequência salva:", e) } return computeSuggestedSequence(e, t) } function renderSequence(e, t, o) { const a = document.getElementById("sequenceList"); a.innerHTML = e.map(((e, o) => { const a = t.find((t => t.nome === e.nome))?.pendente || 0, n = e.hasSubs ? "Fabricar" : "Coletar", r = `<button class="btn-seq-up" data-index="${o}">↑</button><button class="btn-seq-down" data-index="${o}">↓</button>`; return `<li data-nome="${e.nome}" data-index="${o}">${o + 1}. ${n} ${e.nome} (Pendente: ${formatQuantity(a)})${r}</li>` })).join(""), a.querySelectorAll(".btn-seq-up").forEach((a => { a.addEventListener("click", (() => handleSequenceReorder("up", a, e, t, o))) })), a.querySelectorAll(".btn-seq-down").forEach((a => { a.addEventListener("click", (() => handleSequenceReorder("down", a, e, t, o))) })) } function handleSequenceReorder(e, t, o, a, n) { const r = t.closest("li"), i = parseInt(r.dataset.index); let s = [...o]; if ("up" === e && i > 0) [s[i - 1], s[i]] = [s[i], s[i - 1]]; else { if (!("down" === e && i < s.length - 1)) return;[s[i], s[i + 1]] = [s[i + 1], s[i]] } const c = `suggestedSequence_${localStorage.getItem("currentGame") || "Pax Dei"}`; localStorage.setItem(c, JSON.stringify(s.map((e => e.nome)))), renderSequence(s, a, n) } function computeSuggestedSequence(e, t) { const o = new Set(t.map((e => e.nome))), a = new Map, n = new Map; for (let t of e) if (o.has(t.nome)) { n.set(t.nome, n.get(t.nome) || 0); for (let e of t.associados || []) o.has(e.nome) && (a.has(e.nome) || a.set(e.nome, []), a.get(e.nome).push(t.nome), n.set(t.nome, (n.get(t.nome) || 0) + 1)) } for (let e of o) n.has(e) || n.set(e, 0), a.has(e) || a.set(e, []); let r = []; for (let [e, t] of n) 0 === t && r.push(e); let i = []; for (; r.length > 0;) { let t = r.shift(); const o = e.find((e => e.nome === t)), s = o && o.associados && o.associados.length > 0; i.push({ nome: t, hasSubs: s }); for (let e of a.get(t)) n.set(e, n.get(e) - 1), 0 === n.get(e) && r.push(e) } return i } async function fabricarComponente(e, t = 1) { if (!hasPermission("fabricarComponentes")) return void alert("Você não tem permissão para fabricar componentes."); const o = localStorage.getItem("currentGame") || "Pax Dei"; try { const a = await safeApi(`/fabricar?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ componente: e, numCrafts: t }) }); a.sucesso ? (await carregarListaFarmar(document.getElementById("buscaFarmar")?.value || "", document.getElementById("ordemFarmar")?.value || "pendente-desc", document.getElementById("filtroReceitaFarmar")?.value || ""), await carregarEstoque(), await carregarLog(document.getElementById("buscaLogComponente")?.value || "", document.getElementById("filtroLogUser")?.value || "", document.getElementById("filtroLogData")?.value || "")) : mostrarErro(a.erro || "Erro ao fabricar componente") } catch (e) { mostrarErro("Erro ao fabricar componente: " + e.message) } } function collectCategories(e, t, o) { const a = t.find((t => t.nome === e)); if (a && a.categoria && o.add(a.categoria), a && a.associados && a.associados.length > 0) for (const e of a.associados) collectCategories(e.nome, t, o) } async function atualizarEstoqueComponente(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei"; try { const a = await safeApi(`/estoque/set?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ componente: e, novaQuantidade: t }) }); a.sucesso || mostrarErro(a.erro || "Erro ao atualizar estoque") } catch (e) { mostrarErro("Erro ao atualizar estoque: " + e.message) } } async function montarRoadmap() { isUserAdmin(); conteudo.innerHTML = `\n    <h2>Roadmap</h2>\n    <div class="filtros">\n        <label><input type="checkbox" id="filtroProntasRoadmap"> Visualizar somente receitas prontas</label>\n    </div>\n    ${hasPermission("criarRoadmap") ? '<button id="btnInserirNovaReceita" class="primary">Inserir nova receita</button>' : ""}\n    <div id="listaRoadmap" class="lista" style="flex-direction: column;"></div>\n    `, hasPermission("criarRoadmap") && document.getElementById("btnInserirNovaReceita").addEventListener("click", mostrarPopupAdicionarReceitaRoadmap); const e = localStorage.getItem("currentGame") || "Pax Dei", t = JSON.parse(localStorage.getItem(`roadmapFilters_${e}`)) || {}, o = document.getElementById("filtroProntasRoadmap"); o.checked = t.onlyCompleted || !1; o.addEventListener("change", (() => { carregarListaRoadmap(o.checked), localStorage.setItem(`roadmapFilters_${e}`, JSON.stringify({ onlyCompleted: o.checked })) })), await carregarListaRoadmap(o.checked) } async function carregarListaRoadmap(e = !1) { const t = localStorage.getItem("currentGame") || "Pax Dei", o = `recipeQuantities_${t}`; let a = JSON.parse(localStorage.getItem(o)) || {}; try { const n = await safeApi(`/roadmap?game=${encodeURIComponent(t)}`).catch((() => [])), r = await safeApi(`/receitas?game=${encodeURIComponent(t)}`), i = await safeApi(`/componentes?game=${encodeURIComponent(t)}`), s = await safeApi(`/estoque?game=${encodeURIComponent(t)}`), c = {}; s.forEach((e => { c[e.componente] = e.quantidade || 0 })); let d = n; e && (d = n.filter((e => e.completed))); document.getElementById("listaRoadmap").innerHTML = d.map(((t, o) => { if (e && !t.completed) return ""; const i = r.find((e => e.nome === t.name)); if (!i) return ""; n.findIndex((e => e.name === t.name)); const s = `roadmap-${t.name.replace(/\s/g, "-")}-${o}`, c = (i.componentes || []).map((e => `${formatQuantity(e.quantidade)} x ${e.nome}`)).join(", "), l = a[t.name] || 1, m = hasPermission("marcarProntoRoadmap") ? `<label><input type="checkbox" class="checkbox-completed" ${t.completed ? "checked" : ""}> Pronto</label>` : "", u = 0 === o ? "disabled" : "", p = o === d.length - 1 ? "disabled" : "", g = hasPermission("reordenarRoadmap") ? `<button class="btn-move-up" ${u}>↑</button><button class="btn-move-down" ${p}>↓</button>` : "", y = hasPermission("excluirRoadmap") ? '<button class="btn-excluir-roadmap" >Excluir</button>' : ""; return `\n            <div class="item" style="${t.completed ? "background-color: green;" : ""}" data-receita="${t.name}">\n              <div class="receita-header">\n                <div class="receita-header--container1">\n                  <div style="margin-right: 15px;">\n                    <strong class="receita-header--titulo">${t.name}</strong>\n                    ${c ? `<div class="comps-lista">${c}</div>` : ""}\n                    <input type="number" class="qtd-desejada" min="0.001" step="any" value="${l}" data-receita="${t.name}">\n                  </div>\n                  <button class="toggle-detalhes" data-target="${s}-detalhes">▼</button>\n                </div>\n                <div>\n                  ${m}\n                  ${g}\n                  ${y}\n                </div>\n              </div>\n              <div class="detalhes" id="${s}-detalhes" style="display:none;"></div>\n            </div>` })).join(""), document.querySelectorAll("#listaRoadmap .toggle-detalhes").forEach((e => { e.addEventListener("click", (async () => { const t = e.dataset.target, o = document.getElementById(t), a = "none" !== o.style.display; if (o.style.display = a ? "none" : "block", e.textContent = a ? "▼" : "▲", !a) { const t = e.closest(".item"), o = t.dataset.receita, a = Math.max(Number(t.querySelector(".qtd-desejada").value) || .001, .001); await atualizarDetalhes(o, a, i, c, !0, !0) } })) })), document.querySelectorAll("#listaRoadmap .qtd-desejada").forEach((e => { e.addEventListener("input", (async () => { const t = e.closest(".item"), n = t.dataset.receita, r = Math.max(Number(e.value) || .001, .001); a[n] = r, localStorage.setItem(o, JSON.stringify(a)); const s = t.querySelector(".detalhes"); s && "none" !== s.style.display && await atualizarDetalhes(n, r, i, c, !0, !0) })) })), hasPermission("marcarProntoRoadmap") && document.querySelectorAll("#listaRoadmap .checkbox-completed").forEach((e => { e.addEventListener("change", (async () => { const t = e.closest(".item"), o = t.dataset.receita, a = e.checked; await atualizarRoadmapByName(o, { completed: a }), t.style.backgroundColor = a ? "green" : "" })) })), hasPermission("reordenarRoadmap") && (document.querySelectorAll("#listaRoadmap .btn-move-up").forEach((e => { e.addEventListener("click", (async () => { const t = e.closest(".item").dataset.receita, o = document.getElementById("filtroProntasRoadmap")?.checked || !1; await reordenarRoadmapVisual(t, "up", o) })) })), document.querySelectorAll("#listaRoadmap .btn-move-down").forEach((e => { e.addEventListener("click", (async () => { const t = e.closest(".item").dataset.receita, o = document.getElementById("filtroProntasRoadmap")?.checked || !1; await reordenarRoadmapVisual(t, "down", o) })) }))), hasPermission("excluirRoadmap") && document.querySelectorAll("#listaRoadmap .btn-excluir-roadmap").forEach((e => { e.addEventListener("click", (async () => { const t = e.closest(".item").dataset.receita; await excluirRoadmapItemByName(t) })) })) } catch (e) { console.error("[ROADMAP] Erro ao carregar lista:", e); const t = document.getElementById("listaRoadmap"); t && (t.innerHTML = "<p>Erro ao carregar roadmap.</p>") } } async function reordenarRoadmapVisual(e, t, o) { const a = localStorage.getItem("currentGame") || "Pax Dei"; try { const n = await safeApi(`/roadmap?game=${encodeURIComponent(a)}`); let r = o ? n.filter((e => e.completed)) : n; const i = r.findIndex((t => t.name === e)); if (-1 === i) return; let s; if ("up" === t) { if (0 === i) return; s = i - 1 } else { if (i === r.length - 1) return; s = i + 1 } const c = r[i].name, d = r[s].name, l = n.findIndex((e => e.name === c)), m = n.findIndex((e => e.name === d)); if (-1 === l || -1 === m) return;[n[l], n[m]] = [n[m], n[l]], await safeApi(`/roadmap?game=${encodeURIComponent(a)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }), await carregarListaRoadmap(o) } catch (e) { console.error("[REORDENAR ROADMAP] Erro:", e), mostrarErro("Erro ao reordenar roadmap: " + e.message) } } async function atualizarRoadmapByName(e, t) { const o = localStorage.getItem("currentGame") || "Pax Dei"; try { const a = await safeApi(`/roadmap?game=${encodeURIComponent(o)}`), n = a.findIndex((t => t.name === e)); -1 !== n && (Object.assign(a[n], t), await safeApi(`/roadmap?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }), await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1)) } catch (e) { console.error("[ATUALIZAR ROADMAP] Erro:", e), mostrarErro("Erro ao atualizar roadmap: " + e.message) } } async function excluirRoadmapItemByName(e) { if (!confirm("Confirmar exclusão da receita do Roadmap?")) return; const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/roadmap?game=${encodeURIComponent(t)}`), a = o.findIndex((t => t.name === e)); if (-1 === a) return void mostrarErro("Item não encontrado no roadmap."); o.splice(a, 1); const n = await safeApi(`/roadmap?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }); n.sucesso ? await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1) : mostrarErro(n.erro || "Erro ao excluir do roadmap") } catch (e) { mostrarErro("Erro ao excluir do roadmap: " + e.message) } } function mostrarPopupAdicionarReceitaRoadmap() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupAdicionarRoadmap", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Adicionar Receita ao Roadmap</h2>\n        <form id="formAdicionarRoadmap">\n            <input type="text" id="searchReceitaRoadmap" list="receitasDatalistRoadmap" placeholder="Digite para buscar receita..." required>\n            <datalist id="receitasDatalistRoadmap"></datalist>\n            <select id="posicaoRoadmap">\n                <option value="end">Adicionar no final</option>\n                <option value="start">Adicionar no início</option>\n            </select>\n            <button type="submit" id="btnAdicionarRoadmap">Adicionar</button>\n            <button type="button" id="btnCancelarAdicionarRoadmap">Cancelar</button>\n        </form>\n    ', document.body.appendChild(t); const o = localStorage.getItem("currentGame") || "Pax Dei"; safeApi(`/receitas?game=${encodeURIComponent(o)}`).then((e => { const t = document.getElementById("receitasDatalistRoadmap"); t.innerHTML = e.map((e => `<option value="${e.nome}">`)).join(""); const o = document.getElementById("searchReceitaRoadmap"); o.addEventListener("input", (() => { const a = o.value.toLowerCase(), n = e.filter((e => e.nome.toLowerCase().includes(a))); t.innerHTML = n.map((e => `<option value="${e.nome}">`)).join("") })) })).catch((e => { console.error("[ROADMAP DATALIST] Erro ao carregar receitas:", e) })), document.getElementById("formAdicionarRoadmap").addEventListener("submit", (async a => { a.preventDefault(); const n = document.getElementById("searchReceitaRoadmap").value.trim(), r = document.getElementById("posicaoRoadmap").value; if (n) try { const a = await safeApi(`/roadmap?game=${encodeURIComponent(o)}`).catch((() => [])); if (a.some((e => e.name === n))) return void mostrarErro("Esta receita já existe no roadmap. Não é possível adicionar duplicatas."); const i = { name: n, completed: !1 }; "start" === r ? a.unshift(i) : a.push(i), await safeApi(`/roadmap?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }), t.remove(), e.remove(), await carregarListaRoadmap(document.getElementById("filtroProntasRoadmap")?.checked || !1) } catch (e) { mostrarErro("Erro ao adicionar ao roadmap: " + e.message) } else mostrarErro("Selecione uma receita") })), document.getElementById("btnCancelarAdicionarRoadmap").addEventListener("click", (() => { t.remove(), e.remove() })) } async function montarCategorias() { conteudo.innerHTML = `\n    <h2>Categorias</h2>\n    <div class="filtros">\n        <input type="text" id="buscaCategorias" placeholder="Buscar por nome...">\n        <select id="ordemCategorias">\n            <option value="az">Alfabética A-Z</option>\n            <option value="za">Alfabética Z-A</option>\n        </select>\n        ${hasPermission("criarCategorias") ? '<button id="btnNovaCategoria" class="primary">+ Nova Categoria</button>' : ""}\n    </div>\n    <div id="lista-categorias" class="lista"></div>\n    `, hasPermission("criarCategorias") && document.getElementById("btnNovaCategoria").addEventListener("click", (() => abrirPopupCategoria(null))); const e = document.getElementById("buscaCategorias"), t = document.getElementById("ordemCategorias"), o = localStorage.getItem("currentGame") || "Pax Dei", a = JSON.parse(localStorage.getItem(`categoriasFilters_${o}`)) || {}; e.value = a.termoBusca || "", t.value = a.ordem || "az"; const n = () => { localStorage.setItem(`categoriasFilters_${o}`, JSON.stringify({ termoBusca: e.value, ordem: t.value })) }, r = debounce(carregarCategoriasLista, 300); e.addEventListener("input", (() => { r(e.value, t.value), n() })), t.addEventListener("change", (() => { r(e.value, t.value), n() })), await carregarCategoriasLista(e.value, t.value) } async function carregarCategoriasLista(e = "", t = "az") { const o = localStorage.getItem("currentGame") || "Pax Dei"; try { const a = await safeApi(`/categorias?game=${encodeURIComponent(o)}`); let n = Array.isArray(a) ? a : []; const r = await safeApi(`/componentes?game=${encodeURIComponent(o)}`), i = Array.isArray(r) ? r : [], s = {}; i.forEach((e => { e.categoria && (s[e.categoria] = (s[e.categoria] || 0) + 1) })), e && (n = n.filter((t => t.toLowerCase().includes(e.toLowerCase())))), "az" === t ? n.sort(((e, t) => e.localeCompare(t))) : "za" === t && n.sort(((e, t) => t.localeCompare(e))); const c = document.getElementById("lista-categorias"); c && (c.innerHTML = n.map((e => { const t = s[e] || 0; return `\n          <div class="item">\n            <div>\n              <strong>${e}</strong> (${t} componentes)\n            </div>\n            <div class="acoes">\n              ${hasPermission("excluirCategorias") && 0 === t ? `<button onclick="excluirCategoria('${escapeJsString(e)}')" class="warn">Excluir</button>` : ""}\n            </div>\n          </div>` })).join("")) } catch (e) { console.error("[CATEGORIAS] Erro ao carregar dados:", e); const t = document.getElementById("lista-categorias"); t && (t.innerHTML = "<p>Erro ao carregar categorias.</p>") } } function abrirPopupCategoria() { const e = criarOverlay(), t = document.createElement("div"); t.id = "popupCategoria", t.style.position = "fixed", t.style.top = "50%", t.style.left = "50%", t.style.transform = "translate(-50%, -50%)", t.style.backgroundColor = "white", t.style.padding = "20px", t.style.zIndex = "1000", t.innerHTML = '\n        <h2>Nova Categoria</h2>\n        <form id="formCategoria">\n            <input type="text" id="categoriaNome" placeholder="Nome da Categoria" required pattern="[a-zA-Z0-9 ]+">\n            <button type="submit" id="btnCriarCategorias">Criar</button>\n            <button type="button" id="btnCancelarCategoria">Cancelar</button>\n            <p id="erroCategoria" style="color: red; display: none;"></p>\n        </form>\n    ', document.body.appendChild(t); const o = localStorage.getItem("currentGame") || "Pax Dei"; document.getElementById("formCategoria").addEventListener("submit", (async a => { a.preventDefault(); const n = document.getElementById("categoriaNome").value.trim(); if (n) try { const a = await safeApi(`/categorias?game=${encodeURIComponent(o)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: n }) }); if (a.sucesso) t.remove(), e.remove(), await carregarCategoriasLista(document.getElementById("buscaCategorias")?.value || "", document.getElementById("ordemCategorias")?.value || "az"), await carregarCategoriasDatalist(); else { const e = document.getElementById("erroCategoria"); e && (e.textContent = a.erro || "Erro ao criar categoria", e.style.display = "block") } } catch (e) { const t = document.getElementById("erroCategoria"); t && (t.textContent = "Erro ao criar categoria", t.style.display = "block") } else { const e = document.getElementById("erroCategoria"); e && (e.textContent = "Nome da categoria é obrigatório", e.style.display = "block") } })), document.getElementById("btnCancelarCategoria").addEventListener("click", (() => { t.remove(), e.remove() })) } async function excluirCategoria(e) { if (!hasPermission("excluirCategorias")) return void alert("Você não tem permissão para excluir categorias."); if (!confirm(`Confirmar exclusão da categoria "${e}"?`)) return; const t = localStorage.getItem("currentGame") || "Pax Dei"; try { const o = await safeApi(`/categorias/excluir?game=${encodeURIComponent(t)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nome: e }) }); o.sucesso ? (await carregarCategoriasLista(document.getElementById("buscaCategorias")?.value || "", document.getElementById("ordemCategorias")?.value || "az"), await carregarCategoriasDatalist()) : mostrarErro(o.erro || "Erro ao excluir categoria") } catch (e) { mostrarErro("Erro ao excluir categoria: " + e.message) } } botaoDeMinimizar.addEventListener("click", minimizarOmenu), window.montarAtividadesGuilda = montarAtividadesGuilda;